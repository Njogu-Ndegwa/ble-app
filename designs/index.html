<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Oves | Station App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Dark Theme (Default) - Omnivoltaic Brand */
        :root {
            --bg-primary: #0a0f0f;
            --bg-secondary: #0f1515;
            --bg-tertiary: #141c1c;
            --bg-elevated: #1a2424;
            --border: #1e2d2d;
            --border-subtle: #172222;
            
            --text-primary: #f0fafa;
            --text-secondary: #94b8b8;
            --text-muted: #5a8080;
            
            /* Omnivoltaic Cyan/Teal */
            --accent: #00e5e5;
            --accent-light: #33ffff;
            --accent-dark: #00b8b8;
            --accent-soft: rgba(0, 229, 229, 0.15);
            --accent-glow: rgba(0, 229, 229, 0.4);
            
            --success: #00d9a0;
            --success-soft: rgba(0, 217, 160, 0.15);
            --success-glow: rgba(0, 217, 160, 0.4);
            
            --error: #ff5a5a;
            --error-soft: rgba(255, 90, 90, 0.15);
            
            --info: #00b4d8;
            --info-soft: rgba(0, 180, 216, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* Typography Scale */
            --font-xs: 9px;    /* Badges, periods */
            --font-sm: 10px;   /* Labels, captions */
            --font-base: 11px; /* Detail values, muted text */
            --font-md: 12px;   /* Body text, buttons, inputs */
            --font-lg: 13px;   /* Emphasized body */
            --font-xl: 14px;   /* Subtitles */
            --font-2xl: 18px;  /* Page titles */
            --font-3xl: 20px;  /* Large values */
            --font-4xl: 24px;  /* Hero values */
            
            --shadow-glow: 0 0 60px -15px var(--accent-glow);
            --shadow-card: 0 4px 24px -8px rgba(0, 0, 0, 0.5);
            
            --loading-overlay: rgba(10, 15, 15, 0.92);
            --logo-icon-text: #0a0f0f;
        }

        /* Light Theme - Omnivoltaic Brand */
        [data-theme="light"] {
            --bg-primary: #f5fafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8f4f4;
            --bg-elevated: #d8ebeb;
            --border: #b8d4d4;
            --border-subtle: #d0e5e5;
            
            --text-primary: #0a1a1a;
            --text-secondary: #3d5555;
            --text-muted: #6a8888;
            
            /* Omnivoltaic Cyan/Teal - slightly darker for light mode */
            --accent: #00b8b8;
            --accent-light: #00d4d4;
            --accent-dark: #009999;
            --accent-soft: rgba(0, 184, 184, 0.15);
            --accent-glow: rgba(0, 184, 184, 0.35);
            
            --success: #00a878;
            --success-soft: rgba(0, 168, 120, 0.12);
            --success-glow: rgba(0, 168, 120, 0.3);
            
            --error: #dc3545;
            --error-soft: rgba(220, 53, 69, 0.12);
            
            --info: #0094b8;
            --info-soft: rgba(0, 148, 184, 0.12);
            
            --shadow-glow: 0 0 60px -15px var(--accent-glow);
            --shadow-card: 0 4px 24px -8px rgba(0, 80, 80, 0.1);
            
            --loading-overlay: rgba(245, 250, 250, 0.95);
            --logo-icon-text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* App Container */
        .app {
            height: 100%;
            max-width: 430px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            position: relative;
            overflow: hidden;
        }

        /* Background Pattern */
        .app::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, var(--accent-soft) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        .header {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }
        
        @media (max-height: 700px) {
            .header {
                padding: 8px 16px;
            }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 32px;
            width: auto;
            object-fit: contain;
        }
        
        @media (max-height: 700px) {
            .logo-img {
                height: 28px;
            }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--success-soft);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--success);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .theme-toggle:hover {
            border-color: var(--accent);
            background: var(--bg-tertiary);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: absolute;
        }

        .theme-toggle .icon-sun {
            opacity: 0;
            transform: rotate(-90deg) scale(0);
        }

        .theme-toggle .icon-moon {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="light"] .theme-toggle .icon-sun {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="light"] .theme-toggle .icon-moon {
            opacity: 0;
            transform: rotate(90deg) scale(0);
        }

        /* Theme Transition */
        html {
            transition: background-color 0.3s ease;
        }

        html.theme-transition,
        html.theme-transition *,
        html.theme-transition *::before,
        html.theme-transition *::after {
            transition: background-color 0.3s ease, 
                        border-color 0.3s ease, 
                        color 0.3s ease,
                        box-shadow 0.3s ease !important;
        }

        /* Main Content */
        .main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 16px 90px;
            position: relative;
            z-index: 5;
        }

        .main.no-padding-bottom {
            padding-bottom: 16px;
        }
        
        /* Onboarding specific - no horizontal padding needed */
        #module-onboarding .main {
            padding: 0;
            height: calc(100vh - 56px);
            overflow: hidden;
        }

        /* Module/View States */
        .module {
            display: none;
            height: 100%;
        }

        .module.active {
            display: flex;
            flex-direction: column;
        }

        /* Screen States */
        .screen {
            display: none;
            animation: fadeSlideIn 0.4s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===================== */
        /* ROLE SELECTION PAGE   */
        /* ===================== */
        .role-selection {
            padding-top: 0;
            display: flex;
            flex-direction: column;
            padding-bottom: 12px;
        }

        /* Hero Section with Bikes */
        .role-hero {
            position: relative;
            margin: 0 -16px 4px;
            padding: 0 16px;
            overflow: hidden;
        }

        /* Atmospheric gradient cloud/mist at bottom */
        .role-hero-atmosphere {
            position: absolute;
            bottom: 0;
            left: -20%;
            right: -20%;
            height: 50px;
            background: linear-gradient(90deg,
                rgba(0, 180, 216, 0.08) 0%,
                rgba(0, 229, 229, 0.18) 30%,
                rgba(0, 200, 200, 0.15) 50%,
                rgba(0, 229, 229, 0.18) 70%,
                rgba(0, 180, 216, 0.08) 100%
            );
            filter: blur(20px);
            pointer-events: none;
        }

        /* Secondary mist layer for depth */
        .role-hero-mist {
            position: absolute;
            bottom: -10px;
            left: -10%;
            right: -10%;
            height: 35px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.04) 30%,
                rgba(255, 255, 255, 0.06) 50%,
                rgba(255, 255, 255, 0.04) 70%,
                transparent 100%
            );
            filter: blur(15px);
            pointer-events: none;
        }

        /* Subtle reflection */
        .role-hero-reflect {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 20px;
            background: radial-gradient(ellipse, rgba(255,255,255,0.03) 0%, transparent 70%);
            pointer-events: none;
        }
        
        @media (max-height: 700px) {
            .role-hero-atmosphere {
                height: 40px;
            }
            .role-hero-mist {
                height: 25px;
            }
        }

        .role-hero-image {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 280px;
            margin: 0 auto;
            padding-bottom: 6px;
        }
        
        @media (min-height: 800px) {
            .role-hero-image {
                max-width: 320px;
            }
        }

        .role-hero-image img {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
        }

        /* Title Section */
        .role-header {
            text-align: center;
            padding: 2px 0 6px;
            position: relative;
            z-index: 2;
        }

        .role-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 1px;
        }

        .role-description {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.3;
            max-width: 240px;
            margin: 0 auto;
        }

        .role-description strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Applet Grid */
        .role-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 145px));
            justify-content: center;
            gap: 8px;
            padding: 0 0 6px;
        }

        .role-applet {
            aspect-ratio: 1;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px;
            position: relative;
            overflow: hidden;
        }

        .role-applet::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--accent-soft) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .role-applet:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -6px var(--accent-glow);
        }

        .role-applet:hover::before {
            opacity: 1;
        }

        .role-applet.selected {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .role-applet.selected::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
        }

        .role-applet .check-icon {
            position: absolute;
            top: 7px;
            right: 7px;
            width: 16px;
            height: 16px;
            color: var(--bg-primary);
            z-index: 2;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }

        .role-applet.selected .check-icon {
            opacity: 1;
            transform: scale(1);
        }

        .role-applet.disabled {
            opacity: 0.45;
            pointer-events: none;
        }

        .role-applet-image {
            width: 70%;
            aspect-ratio: 1;
            margin-bottom: 2px;
            position: relative;
            z-index: 1;
            transition: transform 0.25s ease;
        }

        .role-applet:hover .role-applet-image {
            transform: scale(1.08);
        }

        .role-applet-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .role-applet-label {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            position: relative;
            z-index: 1;
            line-height: 1.2;
        }

        .role-applet-badge {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            padding: 2px 5px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 7px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }


        /* Role Page Action */
        .role-action {
            margin-top: auto;
            padding: 20px 0 4px;
        }

        .role-action .btn {
            width: 100%;
            padding: 12px 16px;
            font-size: 13px;
        }

        .role-action .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .role-action .btn.ready {
            animation: btnPulse 0.3s ease;
        }

        @keyframes btnPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* ===================== */
        /* ONBOARDING CAROUSEL   */
        /* ===================== */
        .onboarding {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100%;
            overflow: hidden;
            padding: 0 16px;
        }

        .onboarding-slides {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }

        .onboarding-slide {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
            pointer-events: none;
        }

        .onboarding-slide.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .onboarding-slide.prev {
            transform: translateX(-100%);
        }

        .onboarding-image {
            width: 140px;
            height: 140px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .onboarding-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .onboarding-content {
            text-align: center;
            max-width: 280px;
        }

        .onboarding-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .onboarding-desc {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Pagination dots */
        .onboarding-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 12px 0;
            flex-shrink: 0;
        }

        .onboarding-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .onboarding-dot.active {
            width: 24px;
            border-radius: 4px;
            background: var(--accent);
        }

        /* Onboarding actions */
        .onboarding-actions {
            padding: 0 0 8px;
            flex-shrink: 0;
        }

        .onboarding-actions .btn {
            width: 100%;
        }

        .onboarding-skip {
            text-align: center;
            padding-bottom: 12px;
            flex-shrink: 0;
        }

        .onboarding-skip button {
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            padding: 8px 16px;
            transition: color 0.2s ease;
        }

        .onboarding-skip button:hover {
            color: var(--text-secondary);
        }
        
        /* Larger screens - expand onboarding */
        @media (min-height: 700px) {
            .onboarding-image {
                width: 160px;
                height: 160px;
                margin-bottom: 20px;
            }
            .onboarding-title {
                font-size: 20px;
                margin-bottom: 10px;
            }
            .onboarding-desc {
                font-size: 13px;
            }
            .onboarding-dots {
                padding: 16px 0;
            }
        }

        /* ===================== */
        /* SPLASH SCREEN         */
        /* ===================== */
        .splash {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }

        .splash.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* Battery swap animation */
        .splash-animation {
            position: relative;
            width: 120px;
            height: 160px;
            margin-bottom: 32px;
        }

        /* Battery shell */
        .splash-battery {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 110px;
            background: var(--bg-tertiary);
            border: 3px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .splash-battery::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: var(--border);
            border-radius: 4px 4px 0 0;
        }

        
        /* Battery charging fill */
        .splash-battery-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: linear-gradient(180deg, var(--accent) 0%, #00a0a0 100%);
            animation: batteryFill 2.3s steps(1, end) forwards;
        }

        @keyframes batteryFill {
            0% { height: 10%; }
            10% { height: 10%; }
            11% { height: 20%; }
            22% { height: 20%; }
            23% { height: 30%; }
            33% { height: 30%; }
            34% { height: 40%; }
            44% { height: 40%; }
            45% { height: 50%; }
            55% { height: 50%; }
            56% { height: 60%; }
            66% { height: 60%; }
            67% { height: 70%; }
            77% { height: 70%; }
            78% { height: 80%; }
            88% { height: 80%; }
            89% { height: 90%; }
            100% { height: 90%; }
        }

        /* Swap arrows */
        .splash-arrows {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .splash-arrow {
            width: 24px;
            height: 24px;
            color: var(--accent);
            animation: arrowBounce 1s ease-in-out infinite;
        }

        .splash-arrow:nth-child(1) {
            animation-delay: 0s;
            opacity: 0.4;
        }

        .splash-arrow:nth-child(2) {
            animation-delay: 0.15s;
            opacity: 0.7;
        }

        .splash-arrow:nth-child(3) {
            animation-delay: 0.3s;
            opacity: 1;
        }

        @keyframes arrowBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(6px); }
        }

        /* Energy particles */
        .splash-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .splash-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            animation: particleFloat 2s ease-in-out infinite;
        }

        .splash-particle:nth-child(1) {
            left: 10%;
            top: 60%;
            animation-delay: 0s;
        }

        .splash-particle:nth-child(2) {
            right: 10%;
            top: 50%;
            animation-delay: 0.5s;
        }

        .splash-particle:nth-child(3) {
            left: 20%;
            top: 30%;
            animation-delay: 1s;
        }

        .splash-particle:nth-child(4) {
            right: 20%;
            top: 70%;
            animation-delay: 1.5s;
        }

        @keyframes particleFloat {
            0%, 100% { 
                opacity: 0;
                transform: translateY(0) scale(0);
            }
            50% { 
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
        }

        .splash-logo-img {
            height: 48px;
            width: auto;
            margin-bottom: 16px;
            object-fit: contain;
        }

        .splash-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            font-size: 12px;
        }

        .splash-loading-dots {
            display: flex;
            gap: 4px;
        }

        .splash-loading-dot {
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            animation: loadingDot 1.2s ease-in-out infinite;
        }

        .splash-loading-dot:nth-child(1) { animation-delay: 0s; }
        .splash-loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .splash-loading-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes loadingDot {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* ===================== */
        /* ATTENDANT MODULE      */
        /* ===================== */

        /* Interactive Timeline */
        .flow-timeline {
            padding: 12px 16px 8px;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .flow-timeline::-webkit-scrollbar {
            display: none;
        }
        
        .timeline-track {
            display: flex;
            align-items: flex-start;
            position: relative;
            min-width: max-content;
            padding: 0 4px;
        }
        
        .timeline-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            cursor: pointer;
            transition: all 0.25s ease;
            padding: 4px 0;
            min-width: 52px;
            flex-shrink: 0;
        }
        
        .timeline-step.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .timeline-step:not(.disabled):hover .timeline-dot {
            transform: scale(1.15);
        }
        
        .timeline-step:not(.disabled):active .timeline-dot {
            transform: scale(0.95);
        }
        
        .timeline-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        
        .timeline-dot svg {
            width: 12px;
            height: 12px;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        .timeline-step-num {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .timeline-label {
            font-size: 9px;
            font-weight: 500;
            color: var(--text-muted);
            text-align: center;
            margin-top: 5px;
            max-width: 54px;
            line-height: 1.2;
            transition: color 0.3s ease;
            white-space: nowrap;
        }
        
        /* Timeline connector line */
        .timeline-connector {
            flex: 1;
            height: 2px;
            background: var(--border);
            margin: 0 -2px;
            margin-top: 14px;
            min-width: 12px;
            position: relative;
            z-index: 1;
            transition: background 0.3s ease;
        }
        
        /* Active state */
        .timeline-step.active .timeline-dot {
            background: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--accent-soft), 0 0 20px -4px var(--accent-glow);
        }
        
        .timeline-step.active .timeline-dot svg,
        .timeline-step.active .timeline-step-num {
            color: var(--bg-primary);
        }
        
        .timeline-step.active .timeline-label {
            color: var(--accent);
            font-weight: 600;
        }
        
        /* Completed state */
        .timeline-step.completed .timeline-dot {
            background: var(--success);
            border-color: var(--success);
        }
        
        .timeline-step.completed .timeline-dot svg {
            color: white;
        }
        
        .timeline-step.completed .timeline-label {
            color: var(--success);
        }
        
        .timeline-connector.completed {
            background: var(--success);
        }
        
        /* Success state for final step */
        .timeline-step.success .timeline-dot {
            background: var(--success);
            border-color: var(--success);
            box-shadow: 0 0 0 4px var(--success-soft), 0 0 20px -4px var(--success-glow);
        }
        
        .timeline-step.success .timeline-dot svg {
            color: white;
        }
        
        .timeline-step.success .timeline-label {
            color: var(--success);
            font-weight: 600;
        }
        
        /* Hover effect for clickable steps */
        .timeline-step.completed:not(.active):hover .timeline-dot {
            box-shadow: 0 0 0 3px var(--success-soft);
        }
        
        /* Mobile scroll hint gradient */
        .flow-timeline::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: linear-gradient(90deg, transparent, var(--bg-primary));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .flow-timeline.can-scroll::after {
            opacity: 1;
        }
        
        /* Compact mode for very small screens */
        @media (max-height: 650px) {
            .flow-timeline {
                padding: 8px 12px 4px;
            }
            .timeline-dot {
                width: 24px;
                height: 24px;
            }
            .timeline-dot svg {
                width: 10px;
                height: 10px;
            }
            .timeline-step-num {
                font-size: 9px;
            }
            .timeline-label {
                font-size: 8px;
                margin-top: 4px;
            }
            .timeline-connector {
                margin-top: 12px;
            }
            .timeline-step {
                min-width: 46px;
            }
        }
        
        /* ===================== */
        /* CUSTOMER STATE PANEL */
        /* ===================== */
        
        /* Fixed customer state summary - visible after customer ID */
        .customer-state-panel {
            position: sticky;
            top: 0;
            z-index: 9;
            padding: 8px 16px 0;
            display: none;
            flex-shrink: 0;
        }
        
        .customer-state-panel.visible {
            display: block;
        }
        
        .customer-state-inner {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 12px;
        }
        
        /* Customer Identity */
        .state-customer {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        
        .state-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-soft);
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .state-customer-info {
            flex: 1;
            min-width: 0;
        }
        
        .state-customer-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .state-plan-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        .state-plan-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Status badges */
        .state-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .state-badge.active {
            background: var(--success-soft);
            color: var(--success);
        }
        
        .state-badge.current {
            background: var(--accent-soft);
            color: var(--accent);
        }
        
        .state-badge.overdue {
            background: var(--error-soft);
            color: var(--error);
        }
        
        /* Battery indicator */
        .state-battery {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            flex-shrink: 0;
        }
        
        .state-battery-icon {
            width: 16px;
            height: 10px;
            border: 1.5px solid var(--success);
            border-radius: 2px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 1px;
        }
        
        .state-battery-icon::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 2px;
            height: 5px;
            background: var(--success);
            border-radius: 0 1px 1px 0;
        }
        
        .state-battery-fill {
            height: 100%;
            width: var(--level, 100%);
            background: var(--success);
            border-radius: 1px;
        }
        
        .state-battery-id {
            font-size: 9px;
            font-weight: 500;
            font-family: 'DM Mono', monospace;
            color: var(--text-secondary);
        }
        
        /* Quota summary - compact horizontal layout */
        .state-quotas {
            display: none;
            gap: 6px;
            margin: 10px 16px 0;
            padding-bottom: 12px;
        }
        
        .state-quotas.visible {
            display: flex;
        }
        
        .state-quota-item {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }
        
        .state-quota-icon {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .state-quota-icon.energy {
            background: rgba(255, 200, 50, 0.15);
            color: #ffc832;
        }
        
        .state-quota-icon.swaps {
            background: var(--accent-soft);
            color: var(--accent);
        }
        
        .state-quota-icon svg {
            width: 12px;
            height: 12px;
        }
        
        .state-quota-info {
            flex: 1;
            min-width: 0;
        }
        
        .state-quota-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: baseline;
            gap: 3px;
        }
        
        .state-quota-value .remaining {
            font-family: 'DM Mono', monospace;
        }
        
        .state-quota-value .unit {
            font-size: 9px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .state-quota-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 3px;
            overflow: hidden;
        }
        
        .state-quota-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .state-quota-fill.good {
            background: var(--success);
        }
        
        .state-quota-fill.warning {
            background: #f0a500;
        }
        
        .state-quota-fill.critical {
            background: var(--error);
        }
        
        /* Compact mode for small screens */
        @media (max-height: 700px) {
            .customer-state-panel {
                padding: 6px 12px 0;
            }
            
            .customer-state-inner {
                padding: 8px 10px;
            }
            
            .state-avatar {
                width: 28px;
                height: 28px;
                font-size: 10px;
            }
            
            .state-customer-name {
                font-size: 11px;
            }
            
            .state-plan-row {
                font-size: 9px;
            }
            
            .state-quotas {
                margin: 8px 12px 0;
                padding-bottom: 10px;
                gap: 6px;
            }
            
            .state-quota-item {
                padding: 6px 8px;
            }
            
            .state-quota-icon {
                width: 16px;
                height: 16px;
            }
            
            .state-quota-icon svg {
                width: 10px;
                height: 10px;
            }
            
            .state-quota-value {
                font-size: 11px;
            }
        }
        
        /* Simple dot progress for sales module (keep existing) */
        .progress-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 0 6px;
            margin-bottom: 0;
        }

        .progress-step {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: var(--accent);
            width: 24px;
            border-radius: 4px;
        }

        .progress-step.completed {
            background: var(--success);
        }

        /* Scan Screen - Compact for mobile */
        .scan-prompt {
            text-align: center;
            padding-top: 8px;
        }

        .scan-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
            letter-spacing: -0.02em;
        }

        .scan-subtitle {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 10px;
        }

        .scanner-area {
            width: 120px;
            height: 120px;
            margin: 0 auto 12px;
            position: relative;
            cursor: pointer;
        }

        .scanner-frame {
            width: 100%;
            height: 100%;
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            position: relative;
            background: var(--bg-secondary);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .scanner-area:hover .scanner-frame {
            border-color: var(--accent);
            box-shadow: var(--shadow-glow);
        }

        .scanner-corners {
            position: absolute;
            inset: 12px;
        }

        .scanner-corners::before,
        .scanner-corners::after,
        .scanner-corner-bl,
        .scanner-corner-br {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-color: var(--accent);
            border-style: solid;
            border-width: 0;
        }

        .scanner-corners::before {
            top: 0;
            left: 0;
            border-top-width: 2px;
            border-left-width: 2px;
            border-top-left-radius: 6px;
        }

        .scanner-corners::after {
            top: 0;
            right: 0;
            border-top-width: 2px;
            border-right-width: 2px;
            border-top-right-radius: 6px;
        }

        .scanner-corner-bl {
            bottom: 0;
            left: 0;
            border-bottom-width: 2px;
            border-left-width: 2px;
            border-bottom-left-radius: 6px;
        }

        .scanner-corner-br {
            bottom: 0;
            right: 0;
            border-bottom-width: 2px;
            border-right-width: 2px;
            border-bottom-right-radius: 6px;
        }

        .scanner-line {
            position: absolute;
            left: 18px;
            right: 18px;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            animation: scanLine 2s ease-in-out infinite;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        @keyframes scanLine {
            0%, 100% { top: 18px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: calc(100% - 18px); opacity: 0; }
        }

        .scanner-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
        }

        .scanner-icon svg {
            width: 36px;
            height: 36px;
            stroke-width: 1;
        }

        .scan-hint {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--text-muted);
            font-size: 11px;
        }

        .scan-hint svg {
            width: 14px;
            height: 14px;
        }

        /* Input Toggle (Scan vs Manual) - Compact */
        .input-toggle {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: var(--radius-sm);
        }

        .toggle-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 8px 10px;
            background: transparent;
            border: none;
            border-radius: var(--radius-xs);
            font-family: inherit;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        .toggle-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .toggle-btn:not(.active):hover {
            color: var(--text-secondary);
            background: var(--bg-elevated);
        }

        /* Input Modes (Customer/Payment) */
        .customer-input-mode,
        .payment-input-mode {
            transition: opacity 0.2s ease;
        }

        .customer-input-mode.hidden,
        .payment-input-mode.hidden {
            display: none;
        }

        /* Manual Entry Form - Compact */
        .manual-entry-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px;
            margin-bottom: 10px;
        }

        .manual-id-input {
            font-family: 'DM Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ===================== */
        /* LOGIN MODULE          */
        /* ===================== */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 80px);
            padding: 20px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-icon {
            width: 64px;
            height: 64px;
            background: var(--accent-soft);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .login-icon svg {
            width: 32px;
            height: 32px;
            color: var(--accent);
        }

        .login-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .login-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .login-form {
            width: 100%;
            max-width: 320px;
        }

        .login-form .form-group {
            margin-bottom: 16px;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .input-with-icon .form-input {
            padding-left: 42px;
        }

        .login-btn {
            width: 100%;
            margin-top: 8px;
            padding: 14px 20px;
        }

        .login-help {
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 16px;
        }

        /* Logged In User Card */
        .logged-in-info {
            width: 100%;
            max-width: 320px;
        }

        .logged-in-info.hidden {
            display: none;
        }

        .logged-user-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 16px;
        }

        .logged-user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .logged-user-details {
            flex: 1;
            min-width: 0;
        }

        .logged-user-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .logged-user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        .logged-user-badge {
            padding: 4px 10px;
            background: var(--success-soft);
            color: var(--success);
            font-size: 10px;
            font-weight: 500;
            border-radius: 12px;
        }

        .switch-user-btn {
            width: 100%;
            margin-top: 8px;
        }

        /* Stats Row - Compact */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            padding: 8px 6px;
            text-align: center;
        }

        .stat-value {
            font-family: 'DM Mono', monospace;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 1px;
        }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        /* Battery & Customer Cards - Compact */
        .battery-card, .customer-card, .cost-card, .receipt-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px;
            margin-bottom: 8px;
        }

        .battery-header, .customer-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .battery-id, .customer-id {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .battery-name {
            font-size: 13px;
            font-weight: 600;
        }

        .battery-status {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
        }

        .battery-status.verified {
            background: var(--success-soft);
            color: var(--success);
        }

        .battery-status.pending {
            background: var(--accent-soft);
            color: var(--accent);
        }

        .battery-visual {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 0;
        }

        .battery-icon-large {
            width: 32px;
            height: 48px;
            background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-tertiary) 100%);
            border: 2px solid var(--border);
            border-radius: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            overflow: visible;
            flex-shrink: 0;
            margin-top: 10px;
        }

        /* Battery terminal cap */
        .battery-icon-large::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 18px;
            height: 10px;
            background: var(--border);
            border-radius: 3px 3px 0 0;
        }

        .battery-level {
            height: var(--level, 35%);
            background: linear-gradient(180deg, var(--accent) 0%, #00a0a0 100%);
            transition: height 0.5s ease;
        }

        .battery-level.full {
            background: linear-gradient(180deg, var(--success) 0%, #00a078 100%);
        }

        .battery-info {
            flex: 1;
        }

        .battery-charge {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 2px;
            line-height: 1;
        }

        .battery-charge-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .battery-meta {
            display: flex;
            gap: 12px;
        }

        .battery-meta-item {
            font-size: 11px;
            color: var(--text-muted);
        }

        .battery-meta-item span {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Compact Battery Return Card - matches other card styles */
        .battery-return-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px;
            margin-bottom: 8px;
        }
        
        .battery-return-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .battery-return-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        
        .battery-return-status {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--success-soft);
            color: var(--success);
        }
        
        .battery-return-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .battery-return-id {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .battery-return-charge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }
        
        .battery-return-icon {
            width: 18px;
            height: 12px;
            border: 2px solid var(--border);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }
        
        .battery-return-icon::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 6px;
            background: var(--border);
            border-radius: 0 2px 2px 0;
        }
        
        .battery-return-icon.low {
            border-color: var(--error);
        }
        
        .battery-return-icon.low::after {
            background: var(--error);
        }
        
        .battery-return-icon.medium {
            border-color: #f59e0b;
        }
        
        .battery-return-icon.medium::after {
            background: #f59e0b;
        }
        
        .battery-return-icon.full {
            border-color: var(--success);
        }
        
        .battery-return-icon.full::after {
            background: var(--success);
        }
        
        .battery-return-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--level, 35%);
        }
        
        .battery-return-icon.low .battery-return-fill {
            background: var(--error);
        }
        
        .battery-return-icon.medium .battery-return-fill {
            background: #f59e0b;
        }
        
        .battery-return-icon.full .battery-return-fill {
            background: var(--success);
        }
        
        .battery-return-percent {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .battery-return-unit {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Visual Battery Swap Comparison - Compact */
        .battery-swap-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 14px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
        }

        .battery-swap-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding-top: 8px;
        }

        .battery-icon-swap {
            width: 44px;
            height: 62px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        /* Battery terminal/cap on top */
        .battery-icon-swap::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 8px;
            background: var(--border);
            border-radius: 2px 2px 0 0;
        }

        .battery-icon-swap.low {
            border-color: var(--error);
        }
        
        .battery-icon-swap.low::before {
            background: var(--error);
        }

        .battery-icon-swap.medium {
            border-color: #f59e0b;
        }
        
        .battery-icon-swap.medium::before {
            background: #f59e0b;
        }

        .battery-icon-swap.full {
            border-color: var(--success);
        }
        
        .battery-icon-swap.full::before {
            background: var(--success);
        }

        .battery-level-swap {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--level, 50%);
            transition: height 0.5s ease;
        }

        .battery-icon-swap.low .battery-level-swap {
            background: linear-gradient(180deg, var(--error) 0%, #cc4444 100%);
        }

        .battery-icon-swap.medium .battery-level-swap {
            background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
        }

        .battery-icon-swap.full .battery-level-swap {
            background: linear-gradient(180deg, var(--success) 0%, #00a878 100%);
        }

        .battery-percent {
            position: relative;
            z-index: 1;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .battery-swap-label {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .battery-swap-id {
            font-family: 'DM Mono', monospace;
            font-size: 9px;
            color: var(--text-secondary);
        }

        .swap-arrow-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--accent-soft);
            border-radius: 50%;
        }

        .swap-arrow-icon svg {
            width: 16px;
            height: 16px;
            color: var(--accent);
        }

        /* Energy Differential Badge - Compact */
        .energy-diff-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 5px 12px;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 16px;
            margin: 0 auto 8px;
            width: fit-content;
        }

        .energy-diff-badge svg {
            width: 14px;
            height: 14px;
            color: var(--accent);
        }

        .energy-diff-badge span {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
        }

        /* Customer Info */
        .customer-card {
            padding: 12px;
        }

        .customer-header {
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .customer-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .customer-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 1px;
        }

        .customer-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .detail-item {
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
        }

        .detail-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 11px;
            font-weight: 500;
        }

        /* Service Plan Summary - Ultra compact quota display */
        .plan-quotas {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }

        .plan-quotas.single {
            max-width: 50%;
        }

        .quota-chip {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 8px 10px;
            min-width: 0;
        }

        .quota-chip-icon {
            width: 24px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .quota-chip-icon svg {
            width: 14px;
            height: 14px;
            color: var(--text-muted);
        }

        .quota-chip-icon.energy svg {
            color: #fbbf24;
        }

        .quota-chip-icon.swaps svg {
            color: var(--accent);
        }

        .quota-chip-content {
            flex: 1;
            min-width: 0;
        }

        .quota-chip-bar {
            height: 3px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .quota-chip-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.4s ease;
        }

        .quota-chip-fill.good {
            background: var(--success);
        }

        .quota-chip-fill.warning {
            background: #f59e0b;
        }

        .quota-chip-fill.critical {
            background: var(--error);
        }

        .quota-chip-text {
            display: flex;
            align-items: baseline;
            gap: 3px;
        }

        .quota-chip-remaining {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .quota-chip-unit {
            font-size: 9px;
            color: var(--text-muted);
        }

        .quota-chip-label {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Even more compact: inline quota badges */
        .quota-inline {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .quota-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 4px 10px 4px 6px;
        }

        .quota-badge-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .quota-badge-dot.good { background: var(--success); }
        .quota-badge-dot.warning { background: #f59e0b; }
        .quota-badge-dot.critical { background: var(--error); }

        .quota-badge-text {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .quota-badge-text strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Cost Breakdown - Compact */
        .cost-title {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .cost-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .cost-row:last-child {
            border-bottom: none;
        }

        .cost-label {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .cost-value {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
        }

        .cost-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--accent-soft);
            border-radius: var(--radius-sm);
            margin-top: 6px;
        }

        .cost-total-label {
            font-weight: 500;
            font-size: 11px;
        }

        .cost-total-value {
            font-family: 'DM Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
        }

        /* Payment Scan - Compact */
        .payment-scan {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .payment-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .payment-subtitle {
            color: var(--text-secondary);
            font-size: 10px;
            margin-bottom: 10px;
        }

        .qr-scanner-area {
            width: 90px;
            height: 90px;
            margin: 0 auto 8px;
            position: relative;
        }

        .qr-scanner-frame {
            width: 100%;
            height: 100%;
            border: 2px dashed var(--accent);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .qr-scanner-frame:hover {
            background: var(--accent-soft);
            border-style: solid;
        }

        .qr-scanner-frame svg {
            width: 28px;
            height: 28px;
            color: var(--accent);
        }

        .payment-amount {
            font-family: 'DM Mono', monospace;
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 2px;
        }

        .payment-status {
            color: var(--text-muted);
            font-size: 9px;
        }

        /* Success Screen - Compact */
        .success-screen {
            text-align: center;
            padding-top: 12px;
        }

        .success-icon {
            width: 52px;
            height: 52px;
            background: var(--success-soft);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            animation: successPop 0.5s ease-out;
        }

        @keyframes successPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .success-icon svg {
            width: 26px;
            height: 26px;
            color: var(--success);
        }

        .success-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .success-message {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 10px;
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 6px;
            border-bottom: 1px dashed var(--border);
            margin-bottom: 6px;
        }

        .receipt-title {
            font-size: 11px;
            font-weight: 500;
        }

        .receipt-id {
            font-family: 'DM Mono', monospace;
            font-size: 9px;
            color: var(--text-muted);
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 10px;
        }

        .receipt-label {
            color: var(--text-muted);
        }

        .receipt-value {
            font-weight: 500;
        }

        /* ===================== */
        /* SALES REP MODULE      */
        /* ===================== */

        /* Form Styles */
        .form-section {
            margin-bottom: 14px;
        }

        .form-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-label {
            display: block;
            font-size: 10px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 12px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-soft);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        /* Product Selection */
        .product-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .product-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .product-card:hover {
            border-color: var(--accent);
        }

        .product-card.selected {
            border-color: var(--accent);
            background: var(--accent-soft);
        }

        .product-radio {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .product-card.selected .product-radio {
            border-color: var(--accent);
            background: var(--accent);
        }

        .product-radio::after {
            content: '';
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }

        .product-card.selected .product-radio::after {
            opacity: 1;
            transform: scale(1);
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 1px;
        }

        .product-desc {
            font-size: 10px;
            color: var(--text-muted);
        }

        .product-price {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
        }

        .product-price-period {
            font-size: 9px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Customer Preview Card */
        .preview-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 12px;
            margin-bottom: 12px;
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .preview-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .preview-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 1px;
        }

        .preview-phone {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .preview-badge {
            margin-left: auto;
            padding: 3px 8px;
            background: var(--info-soft);
            color: var(--info);
            border-radius: 10px;
            font-size: 9px;
            font-weight: 500;
        }

        .preview-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        /* Checkout Summary */
        .checkout-summary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 12px;
            margin-bottom: 12px;
        }

        .checkout-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .checkout-item:last-child {
            border-bottom: none;
        }

        .checkout-item-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .checkout-item-value {
            font-size: 11px;
            font-weight: 500;
        }

        .checkout-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: var(--success-soft);
            border-radius: var(--radius-md);
            margin-top: 8px;
        }

        .checkout-total-label {
            font-weight: 500;
            font-size: 12px;
            color: var(--success);
        }

        .checkout-total-value {
            font-family: 'DM Mono', monospace;
            font-size: 18px;
            font-weight: 600;
            color: var(--success);
        }

        /* Bottom Action Bar */
        .action-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 430px;
            padding: 12px 16px;
            background: linear-gradient(to top, var(--bg-primary) 85%, transparent);
            z-index: 100;
        }

        .action-bar-inner {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn svg {
            width: 18px;
            height: 18px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #00a0a0 100%);
            color: #ffffff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px -8px var(--accent-glow);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--text-muted);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #00a078 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px -8px var(--success-glow);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-outline:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--loading-overlay);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* Back to Roles Button */
        .back-to-roles {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 0;
            margin-bottom: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 12px;
            transition: color 0.2s ease;
        }

        .back-to-roles:hover {
            color: var(--accent);
        }

        .back-to-roles svg {
            width: 14px;
            height: 14px;
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        /* Scrollbar */
        .main::-webkit-scrollbar {
            width: 4px;
        }

        .main::-webkit-scrollbar-track {
            background: transparent;
        }

        .main::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="assets/Logo-Oves.png" alt="Oves" class="logo-img">
            </div>
            <div class="header-right">
                <div class="status-badge" id="statusBadge">
                    <span class="status-dot"></span>
                    Online
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- ==================== -->
        <!-- SPLASH SCREEN        -->
        <!-- ==================== -->
        <div class="splash" id="splash-screen">
            <div class="splash-content">
                <!-- Battery Swap Animation -->
                <div class="splash-animation">
                    <!-- Swap arrows coming down -->
                    <div class="splash-arrows">
                        <svg class="splash-arrow" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4l-8 8h5v8h6v-8h5z"/>
                        </svg>
                        <svg class="splash-arrow" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4l-8 8h5v8h6v-8h5z"/>
                        </svg>
                        <svg class="splash-arrow" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 4l-8 8h5v8h6v-8h5z"/>
                        </svg>
                    </div>
                    
                    <!-- Battery with charging animation -->
                    <div class="splash-battery">
                        <div class="splash-battery-fill"></div>
                    </div>
                    
                    <!-- Floating energy particles -->
                    <div class="splash-particles">
                        <div class="splash-particle"></div>
                        <div class="splash-particle"></div>
                        <div class="splash-particle"></div>
                        <div class="splash-particle"></div>
                    </div>
                </div>

                <img src="assets/Logo-Oves.png" alt="Omnivoltaic" class="splash-logo-img">
                
                <div class="splash-loading">
                    <span>Loading</span>
                    <div class="splash-loading-dots">
                        <div class="splash-loading-dot"></div>
                        <div class="splash-loading-dot"></div>
                        <div class="splash-loading-dot"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- ONBOARDING MODULE    -->
        <!-- ==================== -->
        <div class="module" id="module-onboarding">
            <main class="main no-padding-bottom">
                <div class="onboarding">
                    <div class="onboarding-slides">
                        <!-- Slide 1: Attendant -->
                        <div class="onboarding-slide active" data-slide="0">
                            <div class="onboarding-image">
                                <img src="assets/Attendant.png" alt="Swap Attendant">
                            </div>
                            <div class="onboarding-content">
                                <h2 class="onboarding-title">Swap Attendant</h2>
                                <p class="onboarding-desc">Process battery swaps quickly and efficiently. Scan batteries, verify customer ownership, and confirm payments in seconds.</p>
                            </div>
                        </div>

                        <!-- Slide 2: Sales Rep -->
                        <div class="onboarding-slide" data-slide="1">
                            <div class="onboarding-image">
                                <img src="assets/Sales.png" alt="Sales Representative">
                            </div>
                            <div class="onboarding-content">
                                <h2 class="onboarding-title">Sales Representative</h2>
                                <p class="onboarding-desc">Register new customers, set up subscription plans, and assign batteries. Grow the network one rider at a time.</p>
                            </div>
                        </div>

                        <!-- Slide 3: Rider -->
                        <div class="onboarding-slide" data-slide="2">
                            <div class="onboarding-image">
                                <img src="assets/Rider.png" alt="Rider">
                            </div>
                            <div class="onboarding-content">
                                <h2 class="onboarding-title">Rider App</h2>
                                <p class="onboarding-desc">Self-service battery swapping for riders. Find nearby stations, check battery status, and swap on the go.</p>
                            </div>
                        </div>

                        <!-- Slide 4: Keypad -->
                        <div class="onboarding-slide" data-slide="3">
                            <div class="onboarding-image">
                                <img src="assets/Keypad.png" alt="Keypad">
                            </div>
                            <div class="onboarding-content">
                                <h2 class="onboarding-title">Keypad</h2>
                                <p class="onboarding-desc">Enter codes to interact with Oves BLE devices. A universal interface for authentication and device access across the network.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="onboarding-dots">
                        <div class="onboarding-dot active" onclick="goToSlide(0)"></div>
                        <div class="onboarding-dot" onclick="goToSlide(1)"></div>
                        <div class="onboarding-dot" onclick="goToSlide(2)"></div>
                        <div class="onboarding-dot" onclick="goToSlide(3)"></div>
                    </div>

                    <!-- Actions -->
                    <div class="onboarding-actions">
                        <button class="btn btn-primary" id="onboarding-next-btn" onclick="nextSlide()">
                            <span id="onboarding-btn-text">Next</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <div class="onboarding-skip">
                        <button onclick="skipOnboarding()">Skip intro</button>
                    </div>
                </div>
            </main>
        </div>

        <!-- ==================== -->
        <!-- ROLE SELECTION MODULE -->
        <!-- ==================== -->
        <div class="module" id="module-roles">
            <main class="main no-padding-bottom">
                <div class="role-selection">
                    <!-- Hero Section with Bikes -->
                    <div class="role-hero">
                        <div class="role-hero-image">
                            <img src="assets/Bikes Oves.png" alt="Electric Bikes">
                        </div>
                        <!-- Atmospheric cloud/mist effect -->
                        <div class="role-hero-atmosphere"></div>
                        <div class="role-hero-mist"></div>
                        <div class="role-hero-reflect"></div>
                    </div>

                    <!-- Title Section -->
                    <div class="role-header">
                        <h1 class="role-title">Select Your Role</h1>
                        <p class="role-description">
                            Choose <strong>your role</strong> to access the right tools for your daily tasks.
                        </p>
                    </div>

                    <!-- Applet Grid -->
                    <div class="role-grid">
                        <!-- Swap Attendant -->
                        <div class="role-applet" onclick="toggleRoleSelection(this, 'attendant')" data-role="attendant">
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            <div class="role-applet-image">
                                <img src="assets/Attendant.png" alt="Swap Attendant">
                            </div>
                            <span class="role-applet-label">Attendant</span>
                        </div>

                        <!-- Sales Rep -->
                        <div class="role-applet" onclick="toggleRoleSelection(this, 'sales')" data-role="sales">
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            <div class="role-applet-image">
                                <img src="assets/Sales.png" alt="Sales Rep">
                            </div>
                            <span class="role-applet-label">Sales Rep</span>
                        </div>

                        <!-- Station Manager -->
                        <div class="role-applet disabled" onclick="toggleRoleSelection(this, 'manager')" data-role="manager">
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            <div class="role-applet-image">
                                <img src="assets/Keypad.png" alt="Station Manager">
                            </div>
                            <span class="role-applet-label">Manager</span>
                            <span class="role-applet-badge">Coming Soon</span>
                        </div>

                        <!-- Rider -->
                        <div class="role-applet disabled" onclick="toggleRoleSelection(this, 'rider')" data-role="rider">
                            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            <div class="role-applet-image">
                                <img src="assets/Rider.png" alt="Rider">
                            </div>
                            <span class="role-applet-label">Rider</span>
                            <span class="role-applet-badge">Coming Soon</span>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="role-action">
                        <button class="btn btn-primary" id="role-continue-btn" onclick="proceedWithRole()" disabled>
                            <span>Continue</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- ==================== -->
        <!-- LOGIN MODULE         -->
        <!-- ==================== -->
        <div class="module" id="module-login">
            <main class="main no-padding-bottom">
                <!-- Back to Roles -->
                <div class="back-to-roles" onclick="backToRoles()" style="position: absolute; top: 10px; left: 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back
                </div>
                
                <div class="login-container">
                    <!-- Login Header -->
                    <div class="login-header">
                        <div class="login-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <h1 class="login-title" id="login-title">Staff Login</h1>
                        <p class="login-subtitle" id="login-subtitle">Sign in to access your workspace</p>
                    </div>

                    <!-- Login Form -->
                    <div class="login-form">
                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <div class="input-with-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                <input type="tel" class="form-input" id="login-phone" placeholder="+254 7XX XXX XXX">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">PIN</label>
                            <div class="input-with-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                                <input type="password" class="form-input" id="login-pin" placeholder="" maxlength="4" inputmode="numeric">
                            </div>
                        </div>

                        <button class="btn btn-primary login-btn" onclick="handleLogin()">
                            <span>Sign In</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>

                        <p class="login-help">
                            Forgot PIN? Contact your supervisor
                        </p>
                    </div>

                    <!-- Current User Info (shown when logged in before) -->
                    <div class="logged-in-info hidden" id="logged-in-info">
                        <div class="logged-user-card">
                            <div class="logged-user-avatar" id="logged-user-avatar">JM</div>
                            <div class="logged-user-details">
                                <div class="logged-user-name" id="logged-user-name">James Mwangi</div>
                                <div class="logged-user-role" id="logged-user-role">Swap Attendant</div>
                            </div>
                            <span class="logged-user-badge">Active</span>
                        </div>
                        <button class="btn btn-primary login-btn" onclick="continueAsUser()">
                            <span>Continue</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </button>
                        <button class="btn btn-secondary switch-user-btn" onclick="switchUser()">
                            Switch Account
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- ==================== -->
        <!-- ATTENDANT MODULE     -->
        <!-- ==================== -->
        <div class="module" id="module-attendant">
            <!-- Back to Roles - At very top -->
            <div class="back-to-roles" onclick="backToRoles()" style="margin: 0 16px 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Change Role
            </div>

            <!-- Interactive Timeline - 6 steps -->
            <div class="flow-timeline" id="att-timeline">
                <div class="timeline-track">
                    <!-- Step 1: Customer -->
                    <div class="timeline-step active" data-step="1" onclick="attTimelineClick(1)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Customer</span>
                    </div>
                    <div class="timeline-connector" data-after="1"></div>
                    
                    <!-- Step 2: Old Battery -->
                    <div class="timeline-step disabled" data-step="2" onclick="attTimelineClick(2)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="16" height="10" rx="2"/>
                                <path d="M22 11v2"/>
                                <path d="M6 11v2"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Return</span>
                    </div>
                    <div class="timeline-connector" data-after="2"></div>
                    
                    <!-- Step 3: New Battery -->
                    <div class="timeline-step disabled" data-step="3" onclick="attTimelineClick(3)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="16" height="10" rx="2"/>
                                <path d="M22 11v2"/>
                                <path d="M7 11h4M9 9v4"/>
                            </svg>
                        </div>
                        <span class="timeline-label">New</span>
                    </div>
                    <div class="timeline-connector" data-after="3"></div>
                    
                    <!-- Step 4: Review -->
                    <div class="timeline-step disabled" data-step="4" onclick="attTimelineClick(4)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                                <path d="M16 13H8M16 17H8"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Review</span>
                    </div>
                    <div class="timeline-connector" data-after="4"></div>
                    
                    <!-- Step 5: Payment -->
                    <div class="timeline-step disabled" data-step="5" onclick="attTimelineClick(5)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2"/>
                                <path d="M1 10h22"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Pay</span>
                    </div>
                    <div class="timeline-connector" data-after="5"></div>
                    
                    <!-- Step 6: Done -->
                    <div class="timeline-step disabled" data-step="6" onclick="attTimelineClick(6)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Done</span>
                    </div>
                </div>
            </div>

            <!-- Customer State Panel - Fixed/Sticky after identification -->
            <div class="customer-state-panel" id="att-customer-state">
                <div class="customer-state-inner">
                    <!-- Customer Identity -->
                    <div class="state-customer">
                        <div class="state-avatar" id="state-avatar">JM</div>
                        <div class="state-customer-info">
                            <div class="state-customer-name" id="state-customer-name">James Mwangi</div>
                            <div class="state-plan-row">
                                <span class="state-plan-name" id="state-plan-name">7-Day Lux</span>
                                <span class="state-badge active" id="state-status-badge">Active</span>
                                <span class="state-badge current" id="state-payment-badge">Current</span>
                            </div>
                        </div>
                    </div>
                    <!-- Current Battery -->
                    <div class="state-battery" id="state-current-battery">
                        <div class="state-battery-icon">
                            <div class="state-battery-fill" style="--level: 100%;"></div>
                        </div>
                        <span class="state-battery-id" id="state-battery-id">BAT_004</span>
                    </div>
                </div>
            </div>
            
            <!-- Quota Summary - Separate cards below customer panel -->
            <div class="state-quotas" id="state-quotas">
                <!-- Energy Quota -->
                <div class="state-quota-item" id="state-quota-energy">
                    <div class="state-quota-icon energy">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                    </div>
                    <div class="state-quota-info">
                        <div class="state-quota-value">
                            <span class="remaining" id="state-energy-remaining">62</span>
                            <span class="unit">kWh left</span>
                        </div>
                        <div class="state-quota-bar">
                            <div class="state-quota-fill good" id="state-energy-fill" style="width: 11.4%;"></div>
                        </div>
                    </div>
                </div>
                <!-- Swaps Quota -->
                <div class="state-quota-item" id="state-quota-swaps">
                    <div class="state-quota-icon swaps">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M7 16V4m0 0L3 8m4-4l4 4M17 8v12m0 0l4-4m-4 4l-4-4"/>
                        </svg>
                    </div>
                    <div class="state-quota-info">
                        <div class="state-quota-value">
                            <span class="remaining" id="state-swaps-remaining">18</span>
                            <span class="unit">swaps left</span>
                        </div>
                        <div class="state-quota-bar">
                            <div class="state-quota-fill good" id="state-swaps-fill" style="width: 14.3%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <main class="main">
                <!-- Screen 1: Identify Customer -->
                <div class="screen active" id="att-screen-customer">
                    <div class="scan-prompt">
                        <h1 class="scan-title">Identify Customer</h1>
                        
                        <!-- Toggle between Scan and Manual -->
                        <div class="input-toggle">
                            <button class="toggle-btn active" id="toggle-scan" onclick="toggleCustomerInput('scan')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                Scan QR
                            </button>
                            <button class="toggle-btn" id="toggle-manual" onclick="toggleCustomerInput('manual')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9"/>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                </svg>
                                Enter ID
                            </button>
                        </div>
                        
                        <!-- Scan QR Option -->
                        <div class="customer-input-mode" id="customer-scan-mode">
                            <p class="scan-subtitle">Scan customer's QR code</p>
                            
                            <div class="scanner-area" onclick="attScanCustomer()">
                                <div class="scanner-frame">
                                    <div class="scanner-corners">
                                        <div class="scanner-corner-bl"></div>
                                        <div class="scanner-corner-br"></div>
                                    </div>
                                    <div class="scanner-line"></div>
                                    <div class="scanner-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="3" y="3" width="7" height="7"/>
                                            <rect x="14" y="3" width="7" height="7"/>
                                            <rect x="14" y="14" width="7" height="7"/>
                                            <rect x="3" y="14" width="7" height="7"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="scan-hint">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                Customer shows their app QR code
                            </p>
                        </div>
                        
                        <!-- Manual Entry Option -->
                        <div class="customer-input-mode hidden" id="customer-manual-mode">
                            <p class="scan-subtitle">Enter Subscription ID manually</p>
                            
                            <div class="manual-entry-form">
                                <div class="form-group">
                                    <label class="form-label">Subscription ID</label>
                                    <input type="text" class="form-input manual-id-input" id="subscriptionId" placeholder="e.g. SUB-8847-KE" autocomplete="off">
                                </div>
                                <button class="btn btn-primary" onclick="attLookupCustomer()" style="width: 100%; margin-top: 8px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="M21 21l-4.35-4.35"/>
                                    </svg>
                                    Look Up Customer
                                </button>
                            </div>
                            
                            <p class="scan-hint">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                Find ID on customer's account or receipt
                            </p>
                        </div>
                    </div>

                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-value">24</div>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">156</div>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">98%</div>
                            <div class="stat-label">Success</div>
                        </div>
                    </div>
                </div>

                <!-- Screen 2: Scan Old Battery -->
                <div class="screen" id="att-screen-oldbattery">
                    <div class="scan-prompt">
                        <h1 class="scan-title">Scan Old Battery</h1>
                        <p class="scan-subtitle">Scan the battery the customer brought in</p>
                        
                        <div class="scanner-area" onclick="attScanOldBattery()" style="margin: 12px auto;">
                            <div class="scanner-frame">
                                <div class="scanner-corners">
                                    <div class="scanner-corner-bl"></div>
                                    <div class="scanner-corner-br"></div>
                                </div>
                                <div class="scanner-line"></div>
                                <div class="scanner-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M7 7h.01M7 12h.01M7 17h.01M12 7h.01M12 12h.01M12 17h.01M17 7h.01M17 12h.01M17 17h.01"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <p class="scan-hint">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            Verify battery belongs to customer
                        </p>
                    </div>
                </div>

                <!-- Screen 3: Scan New Battery -->
                <div class="screen" id="att-screen-newbattery">
                    <!-- Compact Old Battery Card -->
                    <div class="battery-return-card">
                        <div class="battery-return-header">
                            <span class="battery-return-label">OLD BATTERY</span>
                            <span class="battery-return-status">Matched</span>
                        </div>
                        <div class="battery-return-content">
                            <div class="battery-return-id">BAT-2024-7829</div>
                            <div class="battery-return-charge">
                                <div class="battery-return-icon low">
                                    <div class="battery-return-fill" style="--level: 35%;"></div>
                                </div>
                                <span class="battery-return-percent">35%</span>
                                <span class="battery-return-unit">Charge</span>
                            </div>
                        </div>
                    </div>

                    <div class="scan-prompt">
                        <h1 class="scan-title">Scan New Battery</h1>
                        <p class="scan-subtitle">Scan the fresh battery to give customer</p>
                        
                        <div class="scanner-area" onclick="attScanNewBattery()" style="margin: 12px auto;">
                            <div class="scanner-frame">
                                <div class="scanner-corners">
                                    <div class="scanner-corner-bl"></div>
                                    <div class="scanner-corner-br"></div>
                                </div>
                                <div class="scanner-line"></div>
                                <div class="scanner-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M7 7h.01M7 12h.01M7 17h.01M12 7h.01M12 12h.01M12 17h.01M17 7h.01M17 12h.01M17 17h.01"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Screen 4: Review & Cost -->
                <div class="screen" id="att-screen-review">
                    <!-- Visual Battery Comparison -->
                    <div class="battery-swap-visual">
                        <div class="battery-swap-item">
                            <div class="battery-icon-swap low">
                                <div class="battery-level-swap" style="--level: 35%;"></div>
                                <span class="battery-percent">35%</span>
                            </div>
                            <div class="battery-swap-label">RETURNING</div>
                            <div class="battery-swap-id">BAT-7829</div>
                        </div>
                        
                        <div class="swap-arrow-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M5 12h14M12 5l7 7-7 7"/>
                            </svg>
                        </div>
                        
                        <div class="battery-swap-item">
                            <div class="battery-icon-swap full">
                                <div class="battery-level-swap" style="--level: 100%;"></div>
                                <span class="battery-percent">100%</span>
                            </div>
                            <div class="battery-swap-label">RECEIVING</div>
                            <div class="battery-swap-id">BAT-3156</div>
                        </div>
                    </div>

                    <!-- Energy Differential Badge -->
                    <div class="energy-diff-badge">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                        </svg>
                        <span>+1.63 kWh</span>
                    </div>

                    <div class="cost-card">
                        <div class="cost-title">Cost Breakdown</div>
                        <div class="cost-row">
                            <span class="cost-label">Energy Received</span>
                            <span class="cost-value">1.63 kWh</span>
                        </div>
                        <div class="cost-row">
                            <span class="cost-label">Rate</span>
                            <span class="cost-value">KES 120/kWh</span>
                        </div>
                        <div class="cost-total">
                            <span class="cost-total-label">Total Due</span>
                            <span class="cost-total-value">KES 196</span>
                        </div>
                    </div>
                </div>

                <!-- Screen 5: Confirm Payment -->
                <div class="screen" id="att-screen-payment">
                    <div class="cost-card" style="margin-bottom: 8px;">
                        <div class="cost-total" style="margin-top: 0;">
                            <span class="cost-total-label">Amount to Collect</span>
                            <span class="cost-total-value">KES 196</span>
                        </div>
                    </div>

                    <div class="payment-scan">
                        <h2 class="payment-title">Confirm Payment</h2>
                        
                        <!-- Toggle between Scan and Manual -->
                        <div class="input-toggle">
                            <button class="toggle-btn active" id="toggle-payment-scan" onclick="togglePaymentInput('scan')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="7" height="7"/>
                                    <rect x="14" y="3" width="7" height="7"/>
                                    <rect x="14" y="14" width="7" height="7"/>
                                    <rect x="3" y="14" width="7" height="7"/>
                                </svg>
                                Scan QR
                            </button>
                            <button class="toggle-btn" id="toggle-payment-manual" onclick="togglePaymentInput('manual')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 20h9"/>
                                    <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                </svg>
                                Enter ID
                            </button>
                        </div>
                        
                        <!-- Scan QR Option -->
                        <div class="payment-input-mode" id="payment-scan-mode">
                            <p class="payment-subtitle">Scan customer's QR after payment</p>
                            
                            <div class="qr-scanner-area" onclick="attConfirmPayment()">
                                <div class="qr-scanner-frame">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="3" width="7" height="7"/>
                                        <rect x="14" y="3" width="7" height="7"/>
                                        <rect x="14" y="14" width="7" height="7"/>
                                        <rect x="3" y="14" width="7" height="7"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <div class="payment-amount">KES 196.00</div>
                            <div class="payment-status">Tap to scan customer QR</div>
                        </div>
                        
                        <!-- Manual Entry Option -->
                        <div class="payment-input-mode hidden" id="payment-manual-mode">
                            <p class="payment-subtitle">Enter payment transaction ID</p>
                            
                            <div class="manual-entry-form">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label class="form-label">Payment / Transaction ID</label>
                                    <input type="text" class="form-input manual-id-input" id="paymentId" placeholder="e.g. TXN-892741 or M-PESA code" autocomplete="off">
                                </div>
                                <button class="btn btn-primary" onclick="attLookupPayment()" style="width: 100%; margin-top: 8px;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 6L9 17l-5-5"/>
                                    </svg>
                                    Confirm Payment
                                </button>
                            </div>
                            
                            <div class="payment-amount" style="margin-top: 8px;">KES 196.00</div>
                            <p class="scan-hint" style="margin-top: 4px;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01"/>
                                </svg>
                                Enter M-PESA code or receipt number
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Screen 6: Success -->
                <div class="screen" id="att-screen-success">
                    <div class="success-screen">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                        </div>
                        <h2 class="success-title">Swap Complete!</h2>
                        <p class="success-message">Hand over BAT-2024-3156 to customer</p>
                        
                        <div class="receipt-card">
                            <div class="receipt-header">
                                <span class="receipt-title">Transaction Receipt</span>
                                <span class="receipt-id">#TXN-892741</span>
                            </div>
                            <div class="receipt-row">
                                <span class="receipt-label">Customer</span>
                                <span class="receipt-value">James Mwangi</span>
                            </div>
                            <div class="receipt-row">
                                <span class="receipt-label">Returned</span>
                                <span class="receipt-value">BAT-2024-7829 (35%)</span>
                            </div>
                            <div class="receipt-row">
                                <span class="receipt-label">Issued</span>
                                <span class="receipt-value">BAT-2024-3156 (100%)</span>
                            </div>
                            <div class="receipt-row">
                                <span class="receipt-label">Energy</span>
                                <span class="receipt-value">1.63 kWh</span>
                            </div>
                            <div class="receipt-row">
                                <span class="receipt-label">Amount Paid</span>
                                <span class="receipt-value" style="color: var(--success);">KES 196.00</span>
                            </div>
                            <div class="receipt-row">
                                <span class="receipt-label">Time</span>
                                <span class="receipt-value">14:32:07</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Attendant Action Bar -->
            <div class="action-bar">
                <div class="action-bar-inner">
                    <button class="btn btn-secondary hidden" id="att-btn-back" onclick="attGoBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back
                    </button>
                    <button class="btn btn-primary" id="att-btn-main" onclick="attHandleMainAction()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="att-btn-icon">
                            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        <span id="att-btn-text">Scan Customer</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- SALES REP MODULE     -->
        <!-- ==================== -->
        <div class="module" id="module-sales">
            <!-- Back to Roles - At very top -->
            <div class="back-to-roles" onclick="backToRoles()" style="margin: 0 16px 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Change Role
            </div>

            <!-- Interactive Timeline - 4 steps -->
            <div class="flow-timeline" id="sales-timeline">
                <div class="timeline-track">
                    <!-- Step 1: Customer -->
                    <div class="timeline-step active" data-step="1" onclick="salesTimelineClick(1)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Customer</span>
                    </div>
                    <div class="timeline-connector" data-after="1"></div>
                    
                    <!-- Step 2: Plan -->
                    <div class="timeline-step disabled" data-step="2" onclick="salesTimelineClick(2)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <path d="M14 2v6h6"/>
                                <path d="M16 13H8M16 17H8M10 9H8"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Plan</span>
                    </div>
                    <div class="timeline-connector" data-after="2"></div>
                    
                    <!-- Step 3: Battery -->
                    <div class="timeline-step disabled" data-step="3" onclick="salesTimelineClick(3)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="16" height="10" rx="2"/>
                                <path d="M22 11v2"/>
                                <path d="M7 11h4M9 9v4"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Battery</span>
                    </div>
                    <div class="timeline-connector" data-after="3"></div>
                    
                    <!-- Step 4: Done -->
                    <div class="timeline-step disabled" data-step="4" onclick="salesTimelineClick(4)">
                        <div class="timeline-dot">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                        </div>
                        <span class="timeline-label">Done</span>
                    </div>
                </div>
            </div>

            <main class="main">
                <!-- Screen 1: Customer Registration -->
                <div class="screen active" id="sales-screen-register">
                    <h2 class="scan-title" style="text-align: center; margin-bottom: 4px;">New Customer</h2>
                    <p class="scan-subtitle" style="text-align: center; margin-bottom: 12px;">Enter customer details to get started</p>

                    <div class="form-section">
                        <div class="form-section-title">Personal Information</div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-input" id="firstName" placeholder="John">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-input" id="lastName" placeholder="Doe">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-input" id="phone" placeholder="+254 7XX XXX XXX">
                        </div>

                        <div class="form-group">
                            <label class="form-label">National ID</label>
                            <input type="text" class="form-input" id="nationalId" placeholder="Enter ID number">
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Vehicle Information</div>
                        
                        <div class="form-group">
                            <label class="form-label">Vehicle Registration</label>
                            <input type="text" class="form-input" id="vehicleReg" placeholder="KXX 000X">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Vehicle Type</label>
                                <input type="text" class="form-input" id="vehicleType" placeholder="Motorcycle">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-input" id="vehicleModel" placeholder="TVS HLX 125">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Screen 2: Select Subscription -->
                <div class="screen" id="sales-screen-subscription">
                    <h2 class="scan-title" style="text-align: center; margin-bottom: 4px;">Choose Plan</h2>
                    <p class="scan-subtitle" style="text-align: center; margin-bottom: 12px;">Select a subscription package</p>

                    <div class="product-grid">
                        <div class="product-card" onclick="selectProduct(this, 'daily')">
                            <div class="product-radio"></div>
                            <div class="product-info">
                                <div class="product-name">Daily Pass</div>
                                <div class="product-desc">Unlimited swaps for 24 hours</div>
                            </div>
                            <div class="product-price">
                                KES 150
                                <span class="product-price-period">/day</span>
                            </div>
                        </div>

                        <div class="product-card selected" onclick="selectProduct(this, 'weekly')">
                            <div class="product-radio"></div>
                            <div class="product-info">
                                <div class="product-name">Weekly Plan</div>
                                <div class="product-desc">Unlimited swaps for 7 days</div>
                            </div>
                            <div class="product-price">
                                KES 800
                                <span class="product-price-period">/week</span>
                            </div>
                        </div>

                        <div class="product-card" onclick="selectProduct(this, 'monthly')">
                            <div class="product-radio"></div>
                            <div class="product-info">
                                <div class="product-name">Monthly Plan</div>
                                <div class="product-desc">Unlimited swaps for 30 days</div>
                            </div>
                            <div class="product-price">
                                KES 2,500
                                <span class="product-price-period">/month</span>
                            </div>
                        </div>

                        <div class="product-card" onclick="selectProduct(this, 'payperswap')">
                            <div class="product-radio"></div>
                            <div class="product-info">
                                <div class="product-name">Pay-Per-Swap</div>
                                <div class="product-desc">Pay only when you swap</div>
                            </div>
                            <div class="product-price">
                                KES 0
                                <span class="product-price-period">deposit</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Screen 3: Assign Battery -->
                <div class="screen" id="sales-screen-battery">
                    <h2 class="scan-title" style="text-align: center; margin-bottom: 4px;">Assign Battery</h2>
                    <p class="scan-subtitle" style="text-align: center; margin-bottom: 10px;">Scan a battery to assign to customer</p>

                    <!-- Customer Preview -->
                    <div class="preview-card">
                        <div class="preview-header">
                            <div class="preview-avatar" id="sales-avatar">JD</div>
                            <div>
                                <div class="preview-name" id="sales-customer-name">John Doe</div>
                                <div class="preview-phone" id="sales-customer-phone">+254 712 345 678</div>
                            </div>
                            <span class="preview-badge" id="sales-plan-badge">Weekly Plan</span>
                        </div>
                        <div class="preview-details">
                            <div class="detail-item">
                                <div class="detail-label">Vehicle</div>
                                <div class="detail-value" id="sales-vehicle">KXX 000X</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">National ID</div>
                                <div class="detail-value" id="sales-id">*****678</div>
                            </div>
                        </div>
                    </div>

                    <!-- Battery Scanner -->
                    <div class="scanner-area" onclick="salesSimulateBatteryScan()" style="width: 140px; height: 140px; margin: 10px auto;">
                        <div class="scanner-frame">
                            <div class="scanner-corners" style="inset: 12px;">
                                <div class="scanner-corner-bl"></div>
                                <div class="scanner-corner-br"></div>
                            </div>
                            <div class="scanner-line"></div>
                            <div class="scanner-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width: 36px; height: 36px;">
                                    <rect x="2" y="6" width="20" height="12" rx="2"/>
                                    <path d="M22 10v4"/>
                                    <path d="M6 10v4"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <p class="scan-hint">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4M12 8h.01"/>
                        </svg>
                        Tap to scan battery barcode
                    </p>
                </div>

                <!-- Screen 4: Checkout/Success -->
                <div class="screen" id="sales-screen-checkout">
                    <div class="success-screen" style="padding-top: 30px;">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                        </div>
                        <h2 class="success-title">Registration Complete!</h2>
                        <p class="success-message">Customer has been registered successfully</p>
                        
                        <!-- Checkout Summary -->
                        <div class="checkout-summary" style="text-align: left;">
                            <div class="receipt-header">
                                <span class="receipt-title">Registration Summary</span>
                                <span class="receipt-id" id="sales-reg-id">#REG-104782</span>
                            </div>
                            <div class="checkout-item">
                                <span class="checkout-item-label">Customer</span>
                                <span class="checkout-item-value" id="checkout-name">John Doe</span>
                            </div>
                            <div class="checkout-item">
                                <span class="checkout-item-label">Phone</span>
                                <span class="checkout-item-value" id="checkout-phone">+254 712 345 678</span>
                            </div>
                            <div class="checkout-item">
                                <span class="checkout-item-label">Plan</span>
                                <span class="checkout-item-value" id="checkout-plan">Weekly Plan</span>
                            </div>
                            <div class="checkout-item">
                                <span class="checkout-item-label">Battery Assigned</span>
                                <span class="checkout-item-value" id="checkout-battery">BAT-2024-1156</span>
                            </div>
                            <div class="checkout-item">
                                <span class="checkout-item-label">Battery Charge</span>
                                <span class="checkout-item-value" style="color: var(--success);">100%</span>
                            </div>
                            <div class="checkout-total">
                                <span class="checkout-total-label">Amount Due</span>
                                <span class="checkout-total-value" id="checkout-amount">KES 800</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Sales Rep Action Bar -->
            <div class="action-bar">
                <div class="action-bar-inner">
                    <button class="btn btn-secondary hidden" id="sales-btn-back" onclick="salesGoBack()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Back
                    </button>
                    <button class="btn btn-primary" id="sales-btn-main" onclick="salesHandleMainAction()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="sales-btn-icon">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                        <span id="sales-btn-text">Continue</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Processing...</div>
        </div>
    </div>

    <script>
        // =====================
        // Theme Management
        // =====================
        function initTheme() {
            const savedTheme = localStorage.getItem('swapflow-theme');
            
            // Default to dark theme, only use light if explicitly saved
            if (savedTheme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
            // Dark is default (no data-theme attribute needed)
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            
            html.classList.add('theme-transition');
            
            if (currentTheme === 'light') {
                html.removeAttribute('data-theme');
                localStorage.setItem('swapflow-theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('swapflow-theme', 'light');
            }
            
            setTimeout(() => {
                html.classList.remove('theme-transition');
            }, 300);
        }

        initTheme();

        // =====================
        // Splash Screen
        // =====================
        function showSplashAndProceed() {
            const splash = document.getElementById('splash-screen');
            const onboardingSeen = localStorage.getItem('swapflow-onboarding-seen');
            
            // Show splash for 2.5 seconds then proceed
            setTimeout(() => {
                splash.classList.add('hidden');
                
                if (onboardingSeen === 'true') {
                    // Go straight to roles
                    document.getElementById('module-roles').classList.add('active');
                } else {
                    // Show onboarding
                    document.getElementById('module-onboarding').classList.add('active');
                }
            }, 2500);
        }

        function checkSplash() {
            // Always show splash on page load (it's a loading screen)
            showSplashAndProceed();
        }

        // =====================
        // Onboarding Carousel
        // =====================
        let currentSlide = 0;
        const totalSlides = 4;

        function goToSlide(index) {
            const slides = document.querySelectorAll('.onboarding-slide');
            const dots = document.querySelectorAll('.onboarding-dot');
            
            // Update previous slide
            slides[currentSlide].classList.remove('active');
            slides[currentSlide].classList.add('prev');
            dots[currentSlide].classList.remove('active');
            
            // Small delay then remove prev class
            setTimeout(() => {
                slides[currentSlide].classList.remove('prev');
                currentSlide = index;
                
                // Activate new slide
                slides[currentSlide].classList.add('active');
                dots[currentSlide].classList.add('active');
                
                // Update button text
                updateOnboardingButton();
            }, 50);
        }

        function nextSlide() {
            if (currentSlide < totalSlides - 1) {
                goToSlide(currentSlide + 1);
            } else {
                // Last slide - go to role selection
                finishOnboarding();
            }
        }

        function updateOnboardingButton() {
            const btnText = document.getElementById('onboarding-btn-text');
            if (currentSlide === totalSlides - 1) {
                btnText.textContent = 'Get Started';
            } else {
                btnText.textContent = 'Next';
            }
        }

        function skipOnboarding() {
            finishOnboarding();
        }

        function finishOnboarding() {
            // Mark onboarding as seen
            localStorage.setItem('swapflow-onboarding-seen', 'true');
            
            // Switch to role selection
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            document.getElementById('module-roles').classList.add('active');
        }

        // Check if user has seen onboarding (called after splash)
        function checkOnboarding() {
            const seen = localStorage.getItem('swapflow-onboarding-seen');
            if (seen === 'true') {
                document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
                document.getElementById('module-roles').classList.add('active');
            }
        }

        // =====================
        // Role Selection
        // =====================
        let currentRole = null;
        let selectedRole = null;

        function toggleRoleSelection(element, role) {
            // Remove selection from all applets
            document.querySelectorAll('.role-applet').forEach(applet => {
                applet.classList.remove('selected');
            });
            
            // Select clicked applet
            element.classList.add('selected');
            selectedRole = role;
            
            // Enable continue button
            const continueBtn = document.getElementById('role-continue-btn');
            continueBtn.disabled = false;
            continueBtn.classList.add('ready');
        }

        function proceedWithRole() {
            if (!selectedRole) return;
            
            currentRole = selectedRole;
            
            // Roles that require login
            const requiresLogin = ['attendant', 'sales'];
            
            if (requiresLogin.includes(currentRole)) {
                // Check if user is already logged in for this role
                const loginKey = `oves-${currentRole}-login`;
                const savedLogin = localStorage.getItem(loginKey);
                
                if (savedLogin) {
                    // User has logged in before - show continue option
                    showLoginScreen(true, JSON.parse(savedLogin));
                } else {
                    // First time - show full login form
                    showLoginScreen(false);
                }
            } else {
                // Other roles don't need login - go directly
                goToRoleModule();
            }
        }

        function showLoginScreen(hasExistingLogin, userData = null) {
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            document.getElementById('module-login').classList.add('active');
            
            const loginForm = document.querySelector('.login-form');
            const loggedInInfo = document.getElementById('logged-in-info');
            const loginTitle = document.getElementById('login-title');
            const loginSubtitle = document.getElementById('login-subtitle');
            
            // Set title based on role
            const roleNames = {
                'attendant': 'Attendant',
                'sales': 'Sales Rep'
            };
            loginTitle.textContent = `${roleNames[currentRole]} Login`;
            
            if (hasExistingLogin && userData) {
                // Show continue as existing user
                loginForm.style.display = 'none';
                loggedInInfo.classList.remove('hidden');
                loginSubtitle.textContent = 'Welcome back!';
                
                document.getElementById('logged-user-avatar').textContent = userData.initials;
                document.getElementById('logged-user-name').textContent = userData.name;
                document.getElementById('logged-user-role').textContent = roleNames[currentRole];
            } else {
                // Show login form
                loginForm.style.display = 'block';
                loggedInInfo.classList.add('hidden');
                loginSubtitle.textContent = 'Sign in to access your workspace';
                
                // Clear form
                document.getElementById('login-phone').value = '';
                document.getElementById('login-pin').value = '';
            }
        }

        function handleLogin() {
            const phone = document.getElementById('login-phone').value.trim();
            const pin = document.getElementById('login-pin').value.trim();
            
            if (!phone) {
                document.getElementById('login-phone').focus();
                return;
            }
            if (!pin || pin.length < 4) {
                document.getElementById('login-pin').focus();
                return;
            }
            
            showLoading('Signing in...');
            
            // Simulate authentication
            setTimeout(() => {
                hideLoading();
                
                // Save login state
                const userData = {
                    name: 'James Mwangi',
                    initials: 'JM',
                    phone: phone,
                    loginTime: Date.now()
                };
                
                const loginKey = `oves-${currentRole}-login`;
                localStorage.setItem(loginKey, JSON.stringify(userData));
                
                // Go to role module
                goToRoleModule();
            }, 1500);
        }

        function continueAsUser() {
            showLoading('Loading workspace...');
            setTimeout(() => {
                hideLoading();
                goToRoleModule();
            }, 800);
        }

        function switchUser() {
            // Clear current login and show form
            const loginKey = `oves-${currentRole}-login`;
            localStorage.removeItem(loginKey);
            showLoginScreen(false);
        }

        function goToRoleModule() {
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            
            if (currentRole === 'attendant') {
                document.getElementById('module-attendant').classList.add('active');
                // Reset flow state when entering module fresh
                attResetFlow();
                attGoToScreen(1);
                // Check timeline scroll after a brief delay for DOM update
                setTimeout(checkTimelineScroll, 100);
            } else if (currentRole === 'sales') {
                document.getElementById('module-sales').classList.add('active');
                salesGoToScreen(1);
                // Check timeline scroll after a brief delay for DOM update
                setTimeout(checkSalesTimelineScroll, 100);
            }
        }

        function backToRoles() {
            currentRole = null;
            // Keep selectedRole so it stays highlighted when going back
            document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
            document.getElementById('module-roles').classList.add('active');
        }

        // =====================
        // Attendant Module (6-Step Flow)
        // =====================
        let attCurrentScreen = 1;
        let attHighestReached = 1; // Tracks furthest step reached for navigation
        
        // State storage for each step's data
        let attFlowData = {
            customer: null,
            oldBattery: null,
            newBattery: null,
            cost: null,
            payment: null
        };

        const attScreenConfig = {
            1: { btnText: 'Scan Customer', btnIcon: 'qr', showBack: false },
            2: { btnText: 'Scan Old Battery', btnIcon: 'scan', showBack: true },
            3: { btnText: 'Scan New Battery', btnIcon: 'scan', showBack: true },
            4: { btnText: 'Collect Payment', btnIcon: 'arrow', showBack: true },
            5: { btnText: 'Confirm Payment', btnIcon: 'qr', showBack: true },
            6: { btnText: 'New Swap', btnIcon: 'plus', showBack: false, btnClass: 'btn-success' }
        };

        const attIcons = {
            scan: `<rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h.01M7 12h.01M7 17h.01M12 7h.01M12 12h.01M12 17h.01M17 7h.01M17 12h.01M17 17h.01"/>`,
            arrow: `<path d="M5 12h14M12 5l7 7-7 7"/>`,
            qr: `<rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>`,
            plus: `<path d="M12 5v14M5 12h14"/>`
        };

        // Update the interactive timeline visual state
        function attUpdateTimeline(screenNum) {
            const timeline = document.getElementById('att-timeline');
            if (!timeline) return;
            
            const steps = timeline.querySelectorAll('.timeline-step');
            const connectors = timeline.querySelectorAll('.timeline-connector');
            
            steps.forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed', 'disabled', 'success');
                
                if (stepNum < screenNum) {
                    // Completed steps
                    step.classList.add('completed');
                } else if (stepNum === screenNum) {
                    // Current step
                    if (screenNum === 6) {
                        step.classList.add('success');
                    } else {
                        step.classList.add('active');
                    }
                } else if (stepNum <= attHighestReached) {
                    // Can navigate to (previously visited)
                    step.classList.add('completed');
                } else {
                    // Not yet reachable
                    step.classList.add('disabled');
                }
            });
            
            // Update connectors
            connectors.forEach((connector, index) => {
                const afterStep = index + 1;
                connector.classList.remove('completed');
                if (afterStep < screenNum || afterStep < attHighestReached) {
                    connector.classList.add('completed');
                }
            });
            
            // Scroll active step into view on mobile
            const activeStep = timeline.querySelector('.timeline-step.active, .timeline-step.success');
            if (activeStep) {
                setTimeout(() => {
                    activeStep.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }, 100);
            }
            
            // Check if timeline can scroll (for scroll hint)
            checkTimelineScroll();
        }
        
        function checkTimelineScroll() {
            const timeline = document.getElementById('att-timeline');
            if (!timeline) return;
            const track = timeline.querySelector('.timeline-track');
            if (track && track.scrollWidth > timeline.clientWidth) {
                timeline.classList.add('can-scroll');
            } else {
                timeline.classList.remove('can-scroll');
            }
        }
        
        // Handle timeline step clicks for navigation
        function attTimelineClick(stepNum) {
            // Can only navigate to completed steps or current step
            if (stepNum > attHighestReached) return;
            if (stepNum === attCurrentScreen) return;
            
            // Navigate to the step
            attGoToScreen(stepNum, true);
        }

        function attGoToScreen(screenNum, isNavigation = false) {
            const module = document.getElementById('module-attendant');
            module.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`att-screen-${attGetScreenName(screenNum)}`).classList.add('active');
            
            // Update highest reached (only when progressing forward, not navigating back)
            if (screenNum > attHighestReached && !isNavigation) {
                attHighestReached = screenNum;
            }
            
            // Update the interactive timeline
            attUpdateTimeline(screenNum);
            
            // Toggle customer state panel visibility (visible on screens 2-5)
            toggleCustomerStatePanel(screenNum);
            
            const config = attScreenConfig[screenNum];
            document.getElementById('att-btn-text').textContent = config.btnText;
            document.getElementById('att-btn-icon').innerHTML = attIcons[config.btnIcon];
            
            const btnBack = document.getElementById('att-btn-back');
            const btnMain = document.getElementById('att-btn-main');
            
            if (config.showBack) btnBack.classList.remove('hidden');
            else btnBack.classList.add('hidden');
            
            btnMain.className = 'btn ' + (config.btnClass || 'btn-primary');
            attCurrentScreen = screenNum;
            
            // Restore data for the screen if navigating back
            if (isNavigation) {
                attRestoreScreenData(screenNum);
            }
        }

        function attGetScreenName(num) {
            return { 
                1: 'customer',    // Scan Customer QR
                2: 'oldbattery',  // Scan Old Battery
                3: 'newbattery',  // Scan New Battery
                4: 'review',      // Review & Cost
                5: 'payment',     // Confirm Payment
                6: 'success'      // Complete
            }[num];
        }
        
        // Save data for current step
        function attSaveStepData(step, data) {
            const dataKeys = ['', 'customer', 'oldBattery', 'newBattery', 'cost', 'payment'];
            if (dataKeys[step]) {
                attFlowData[dataKeys[step]] = data;
            }
        }
        
        // Restore data when navigating back to a step
        function attRestoreScreenData(screenNum) {
            // Data is preserved in the DOM already for this demo
            // In a real app, you would repopulate form fields here
            // For now, the simulated data stays intact
        }
        
        // Reset flow when starting a new swap
        function attResetFlow() {
            attHighestReached = 1;
            attFlowData = {
                customer: null,
                oldBattery: null,
                newBattery: null,
                cost: null,
                payment: null
            };
            // Reset manual entry fields
            document.getElementById('subscriptionId').value = '';
            document.getElementById('paymentId').value = '';
            // Reset to scan mode for both customer and payment
            toggleCustomerInput('scan');
            togglePaymentInput('scan');
            // Reset service plan data
            currentServicePlan = null;
            // Hide customer state panel when starting fresh
            hideCustomerStatePanel();
        }

        // Toggle between Scan QR and Manual Entry for Customer
        function toggleCustomerInput(mode) {
            const scanMode = document.getElementById('customer-scan-mode');
            const manualMode = document.getElementById('customer-manual-mode');
            const toggleScan = document.getElementById('toggle-scan');
            const toggleManual = document.getElementById('toggle-manual');
            
            if (mode === 'scan') {
                scanMode.classList.remove('hidden');
                manualMode.classList.add('hidden');
                toggleScan.classList.add('active');
                toggleManual.classList.remove('active');
            } else {
                scanMode.classList.add('hidden');
                manualMode.classList.remove('hidden');
                toggleScan.classList.remove('active');
                toggleManual.classList.add('active');
                // Focus the input field
                setTimeout(() => document.getElementById('subscriptionId').focus(), 100);
            }
        }

        // Toggle between Scan QR and Manual Entry for Payment
        function togglePaymentInput(mode) {
            const scanMode = document.getElementById('payment-scan-mode');
            const manualMode = document.getElementById('payment-manual-mode');
            const toggleScan = document.getElementById('toggle-payment-scan');
            const toggleManual = document.getElementById('toggle-payment-manual');
            
            if (mode === 'scan') {
                scanMode.classList.remove('hidden');
                manualMode.classList.add('hidden');
                toggleScan.classList.add('active');
                toggleManual.classList.remove('active');
            } else {
                scanMode.classList.add('hidden');
                manualMode.classList.remove('hidden');
                toggleScan.classList.remove('active');
                toggleManual.classList.add('active');
                // Focus the input field
                setTimeout(() => document.getElementById('paymentId').focus(), 100);
            }
        }

        // Confirm payment by manual ID entry
        function attLookupPayment() {
            const paymentId = document.getElementById('paymentId').value.trim();
            if (!paymentId) {
                document.getElementById('paymentId').focus();
                return;
            }
            showLoading('Confirming payment...');
            // Save payment data
            attSaveStepData(5, {
                confirmed: true,
                txnId: paymentId.toUpperCase(),
                method: 'manual',
                timestamp: new Date().toISOString()
            });
            setTimeout(() => { hideLoading(); attGoToScreen(6); }, 1200);
        }

        // ===========================================
        // Service Plan Display - Smart Quota Filtering
        // ===========================================
        
        // Simulated service plan data (would come from API in production)
        let currentServicePlan = null;
        
        // Filter services to only show meaningful consumption-based quotas
        function getDisplayableServices(serviceStates) {
            if (!serviceStates || !Array.isArray(serviceStates)) return [];
            
            return serviceStates.filter(service => {
                // Skip access-based services with huge/unlimited quotas
                if (service.quota >= 1000000) return false;
                
                // Skip services with no quota tracking
                if (service.quota <= 0) return false;
                
                // Only keep consumption-based services (electricity, swap-count)
                const id = service.service_id?.toLowerCase() || '';
                return id.includes('electricity') || id.includes('swap-count');
            });
        }
        
        // Determine status color based on usage percentage
        function getQuotaStatus(used, quota) {
            const usedPercent = (used / quota) * 100;
            if (usedPercent >= 90) return 'critical';
            if (usedPercent >= 70) return 'warning';
            return 'good';
        }
        
        // Update service plan data (now handled by customer state panel)
        function updateServicePlanDisplay(servicePlanData) {
            if (!servicePlanData) return;
            currentServicePlan = servicePlanData;
            // All display is now handled by the pinned customer state panel
        }
        
        // ===========================================
        // Customer State Panel - Sticky Summary
        // ===========================================
        
        // Show/hide the customer state panel based on current screen
        function toggleCustomerStatePanel(screenNum) {
            const panel = document.getElementById('att-customer-state');
            const quotas = document.getElementById('state-quotas');
            if (!panel) return;
            
            // Show panel on screens 2-5 (after customer ID, before success)
            // Hide on screen 1 (identification) and screen 6 (success/complete)
            if (screenNum >= 2 && screenNum <= 5) {
                panel.classList.add('visible');
                if (quotas) quotas.classList.add('visible');
            } else {
                panel.classList.remove('visible');
                if (quotas) quotas.classList.remove('visible');
            }
        }
        
        // Populate the customer state panel with service plan data
        function updateCustomerStatePanel(servicePlanData, customerData) {
            if (!servicePlanData) return;
            
            // Customer identity
            const avatar = document.getElementById('state-avatar');
            const customerName = document.getElementById('state-customer-name');
            const planName = document.getElementById('state-plan-name');
            const statusBadge = document.getElementById('state-status-badge');
            const paymentBadge = document.getElementById('state-payment-badge');
            
            // Set customer name and avatar
            if (customerData) {
                if (avatar) avatar.textContent = customerData.initials || 'CU';
                if (customerName) customerName.textContent = customerData.name || 'Customer';
            }
            
            // Extract plan name from template ID
            const templateId = servicePlanData.templateId || servicePlanData.servicePlanId || '';
            let displayPlanName = '7-Day Plan';
            if (templateId.includes('7day')) displayPlanName = '7-Day Lux';
            else if (templateId.includes('30day') || templateId.includes('month')) displayPlanName = '30-Day Plan';
            else if (templateId.includes('pay-per') || templateId.includes('payper')) displayPlanName = 'Pay-Per-Swap';
            if (planName) planName.textContent = displayPlanName;
            
            // Status badge
            if (statusBadge) {
                const status = servicePlanData.status || 'ACTIVE';
                statusBadge.textContent = status.charAt(0) + status.slice(1).toLowerCase();
                statusBadge.className = 'state-badge ' + status.toLowerCase();
            }
            
            // Payment state badge
            if (paymentBadge) {
                const paymentState = servicePlanData.paymentState || 'CURRENT';
                paymentBadge.textContent = paymentState.charAt(0) + paymentState.slice(1).toLowerCase();
                paymentBadge.className = 'state-badge ' + paymentState.toLowerCase();
            }
            
            // Current battery from service states
            const batteryContainer = document.getElementById('state-current-battery');
            const batteryId = document.getElementById('state-battery-id');
            const serviceStates = servicePlanData.serviceStates || [];
            
            // Find battery fleet service to get current asset
            const batteryService = serviceStates.find(s => 
                s.service_id?.toLowerCase().includes('battery-fleet') && s.current_asset
            );
            
            if (batteryService && batteryService.current_asset && batteryContainer) {
                const assetId = batteryService.current_asset;
                // Format battery ID for display (show last part)
                const shortId = assetId.includes('_') ? assetId.split('_').pop() : assetId.slice(-6);
                if (batteryId) batteryId.textContent = `BAT_${shortId}`;
                batteryContainer.style.display = 'flex';
            } else if (batteryContainer) {
                batteryContainer.style.display = 'none';
            }
            
            // Update quota displays
            const displayableServices = getDisplayableServices(serviceStates);
            let energyService = null;
            let swapService = null;
            
            displayableServices.forEach(service => {
                const id = service.service_id?.toLowerCase() || '';
                if (id.includes('electricity')) energyService = service;
                else if (id.includes('swap-count')) swapService = service;
            });
            
            // Energy quota
            const energyQuotaItem = document.getElementById('state-quota-energy');
            const energyRemaining = document.getElementById('state-energy-remaining');
            const energyFill = document.getElementById('state-energy-fill');
            
            if (energyService && energyQuotaItem) {
                const remaining = energyService.quota - energyService.used;
                const usedPercent = (energyService.used / energyService.quota) * 100;
                const status = getQuotaStatus(energyService.used, energyService.quota);
                
                if (energyRemaining) energyRemaining.textContent = remaining;
                if (energyFill) {
                    energyFill.style.width = usedPercent + '%';
                    energyFill.className = 'state-quota-fill ' + status;
                }
                energyQuotaItem.style.display = 'flex';
            } else if (energyQuotaItem) {
                energyQuotaItem.style.display = 'none';
            }
            
            // Swaps quota
            const swapsQuotaItem = document.getElementById('state-quota-swaps');
            const swapsRemaining = document.getElementById('state-swaps-remaining');
            const swapsFill = document.getElementById('state-swaps-fill');
            
            if (swapService && swapsQuotaItem) {
                const remaining = swapService.quota - swapService.used;
                const usedPercent = (swapService.used / swapService.quota) * 100;
                const status = getQuotaStatus(swapService.used, swapService.quota);
                
                if (swapsRemaining) swapsRemaining.textContent = remaining;
                if (swapsFill) {
                    swapsFill.style.width = usedPercent + '%';
                    swapsFill.className = 'state-quota-fill ' + status;
                }
                swapsQuotaItem.style.display = 'flex';
            } else if (swapsQuotaItem) {
                swapsQuotaItem.style.display = 'none';
            }
            
            // Note: quotas container visibility is handled by toggleCustomerStatePanel()
            // Individual quota items are hidden/shown based on service availability above
        }
        
        // Hide customer state panel (for reset)
        function hideCustomerStatePanel() {
            const panel = document.getElementById('att-customer-state');
            const quotas = document.getElementById('state-quotas');
            if (panel) panel.classList.remove('visible');
            if (quotas) quotas.classList.remove('visible');
        }
        
        // Simulated API response data for demo
        const mockServicePlanData = {
            servicePlanId: "bss-plan-togo-7day-lux-plan3",
            customerId: "customer-togo-002",
            status: "ACTIVE",
            serviceState: "BATTERY_ISSUED",
            paymentState: "CURRENT",
            templateId: "template-togo-lome-7day-lux-v2",
            serviceStates: [
                { service_id: "service-swap-station-network-togo-lux", used: 0, quota: 10000000, current_asset: null },
                { service_id: "service-battery-fleet-togo-lux", used: 0, quota: 10000000, current_asset: "BAT_NEW_004" },
                { service_id: "service-electricity-togo-lux", used: 8, quota: 70, current_asset: null },
                { service_id: "service-swap-count-togo-lux", used: 3, quota: 21, current_asset: null }
            ]
        };

        // Step 1a: Scan customer QR
        function attScanCustomer() {
            showLoading('Identifying customer...');
            // Save customer data
            const customerData = {
                id: 'CUS-8847-KE',
                name: 'James Mwangi',
                initials: 'JM',
                plan: '7-Day Lux'
            };
            attSaveStepData(1, customerData);
            
            // Update service plan display with mock data (would be from API in production)
            updateServicePlanDisplay(mockServicePlanData);
            
            // Update the sticky customer state panel
            updateCustomerStatePanel(mockServicePlanData, customerData);
            
            setTimeout(() => { hideLoading(); attGoToScreen(2); }, 1200);
        }

        // Step 1b: Manual lookup by Subscription ID
        function attLookupCustomer() {
            const subId = document.getElementById('subscriptionId').value.trim();
            if (!subId) {
                document.getElementById('subscriptionId').focus();
                return;
            }
            showLoading('Looking up customer...');
            // Save customer data
            const customerData = {
                id: subId,
                name: 'James Mwangi',
                initials: 'JM',
                plan: '7-Day Lux'
            };
            attSaveStepData(1, customerData);
            
            // Update service plan display with mock data (would be from API in production)
            updateServicePlanDisplay(mockServicePlanData);
            
            // Update the sticky customer state panel
            updateCustomerStatePanel(mockServicePlanData, customerData);
            
            setTimeout(() => { hideLoading(); attGoToScreen(2); }, 1500);
        }

        // Step 2: Scan old battery (customer brought)
        function attScanOldBattery() {
            showLoading('Scanning battery...');
            // Save old battery data
            attSaveStepData(2, {
                id: 'BAT-2024-7829',
                charge: 35,
                verified: true
            });
            setTimeout(() => { 
                hideLoading(); 
                showLoading('Verifying ownership...');
                setTimeout(() => { hideLoading(); attGoToScreen(3); }, 800);
            }, 1000);
        }

        // Step 3: Scan new battery (to give customer)
        function attScanNewBattery() {
            showLoading('Scanning new battery...');
            // Save new battery data
            attSaveStepData(3, {
                id: 'BAT-2024-3156',
                charge: 100
            });
            setTimeout(() => { 
                hideLoading(); 
                showLoading('Calculating cost...');
                // Save cost data
                attSaveStepData(4, {
                    energyDiff: 1.63,
                    rate: 120,
                    total: 196
                });
                setTimeout(() => { hideLoading(); attGoToScreen(4); }, 600);
            }, 1000);
        }

        // Step 5: Confirm payment by scanning customer QR
        function attConfirmPayment() {
            showLoading('Confirming payment...');
            // Save payment data
            attSaveStepData(5, {
                confirmed: true,
                txnId: 'TXN-892741',
                time: new Date().toLocaleTimeString('en-US', { hour12: false })
            });
            setTimeout(() => { hideLoading(); attGoToScreen(6); }, 1500);
        }

        function attHandleMainAction() {
            switch(attCurrentScreen) {
                case 1: attScanCustomer(); break;
                case 2: attScanOldBattery(); break;
                case 3: attScanNewBattery(); break;
                case 4: attGoToScreen(5); break;  // Go to payment confirmation
                case 5: attConfirmPayment(); break;
                case 6: 
                    // Reset flow and start new swap
                    attResetFlow();
                    attGoToScreen(1);
                    break;
            }
        }

        function attGoBack() {
            if (attCurrentScreen > 1) attGoToScreen(attCurrentScreen - 1, true);
        }

        // =====================
        // Sales Rep Module
        // =====================
        let salesCurrentScreen = 1;
        let selectedPlan = 'weekly';

        const salesScreenConfig = {
            1: { btnText: 'Continue', btnIcon: 'arrow', showBack: false },
            2: { btnText: 'Continue', btnIcon: 'arrow', showBack: true },
            3: { btnText: 'Scan Battery', btnIcon: 'scan', showBack: true },
            4: { btnText: 'New Registration', btnIcon: 'plus', showBack: false, btnClass: 'btn-success' }
        };

        const salesIcons = {
            arrow: `<path d="M5 12h14M12 5l7 7-7 7"/>`,
            scan: `<rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 7h.01M7 12h.01M7 17h.01M12 7h.01M12 12h.01M12 17h.01M17 7h.01M17 12h.01M17 17h.01"/>`,
            plus: `<path d="M12 5v14M5 12h14"/>`
        };

        function salesGoToScreen(screenNum) {
            const module = document.getElementById('module-sales');
            module.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`sales-screen-${salesGetScreenName(screenNum)}`).classList.add('active');
            
            // Update the interactive timeline
            salesUpdateTimeline(screenNum);
            
            const config = salesScreenConfig[screenNum];
            document.getElementById('sales-btn-text').textContent = config.btnText;
            document.getElementById('sales-btn-icon').innerHTML = salesIcons[config.btnIcon];
            
            const btnBack = document.getElementById('sales-btn-back');
            const btnMain = document.getElementById('sales-btn-main');
            
            if (config.showBack) btnBack.classList.remove('hidden');
            else btnBack.classList.add('hidden');
            
            btnMain.className = 'btn ' + (config.btnClass || 'btn-primary');
            salesCurrentScreen = screenNum;

            // Update preview on screen 3
            if (screenNum === 3) {
                updateSalesPreview();
            }
        }

        // Update the interactive timeline visual state for sales
        function salesUpdateTimeline(screenNum) {
            const timeline = document.getElementById('sales-timeline');
            if (!timeline) return;

            const steps = timeline.querySelectorAll('.timeline-step');
            const connectors = timeline.querySelectorAll('.timeline-connector');

            steps.forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed', 'disabled', 'success');
                
                if (stepNum < screenNum) {
                    // Completed steps
                    step.classList.add('completed');
                } else if (stepNum === screenNum) {
                    // Current step
                    if (screenNum === 4) {
                        // Final step shows success state
                        step.classList.add('success');
                    } else {
                        step.classList.add('active');
                    }
                } else {
                    // Future steps
                    step.classList.add('disabled');
                }
            });

            // Update connectors
            connectors.forEach((conn) => {
                const afterStep = parseInt(conn.getAttribute('data-after'));
                conn.classList.remove('completed');
                if (afterStep < screenNum) {
                    conn.classList.add('completed');
                }
            });

            // Scroll active step into view
            const activeStep = timeline.querySelector('.timeline-step.active, .timeline-step.success');
            if (activeStep) {
                activeStep.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
            }

            // Check if timeline can scroll (for scroll hint)
            checkSalesTimelineScroll();
        }

        function checkSalesTimelineScroll() {
            const timeline = document.getElementById('sales-timeline');
            if (!timeline) return;
            const track = timeline.querySelector('.timeline-track');
            if (track && track.scrollWidth > timeline.clientWidth) {
                timeline.classList.add('can-scroll');
            } else {
                timeline.classList.remove('can-scroll');
            }
        }

        // Handle timeline step clicks for navigation in sales
        function salesTimelineClick(stepNum) {
            // Only allow clicking on completed steps or current step
            const timeline = document.getElementById('sales-timeline');
            const step = timeline.querySelector(`.timeline-step[data-step="${stepNum}"]`);
            
            if (!step || step.classList.contains('disabled')) {
                return; // Can't navigate to disabled steps
            }
            
            salesGoToScreen(stepNum);
        }

        function salesGetScreenName(num) {
            return { 1: 'register', 2: 'subscription', 3: 'battery', 4: 'checkout' }[num];
        }

        function selectProduct(element, plan) {
            document.querySelectorAll('.product-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');
            selectedPlan = plan;
        }

        function updateSalesPreview() {
            const firstName = document.getElementById('firstName').value || 'John';
            const lastName = document.getElementById('lastName').value || 'Doe';
            const phone = document.getElementById('phone').value || '+254 712 345 678';
            const vehicle = document.getElementById('vehicleReg').value || 'KXX 000X';
            const nationalId = document.getElementById('nationalId').value || '12345678';
            
            const initials = (firstName[0] || 'J') + (lastName[0] || 'D');
            const fullName = firstName + ' ' + lastName;
            
            document.getElementById('sales-avatar').textContent = initials.toUpperCase();
            document.getElementById('sales-customer-name').textContent = fullName;
            document.getElementById('sales-customer-phone').textContent = phone;
            document.getElementById('sales-vehicle').textContent = vehicle;
            document.getElementById('sales-id').textContent = '*****' + nationalId.slice(-3);
            
            const planNames = {
                'daily': 'Daily Pass',
                'weekly': 'Weekly Plan',
                'monthly': 'Monthly Plan',
                'payperswap': 'Pay-Per-Swap'
            };
            document.getElementById('sales-plan-badge').textContent = planNames[selectedPlan];
        }

        function salesSimulateBatteryScan() {
            showLoading('Scanning battery...');
            setTimeout(() => {
                hideLoading();
                updateCheckoutSummary();
                salesGoToScreen(4);
            }, 1500);
        }

        function updateCheckoutSummary() {
            const firstName = document.getElementById('firstName').value || 'John';
            const lastName = document.getElementById('lastName').value || 'Doe';
            const phone = document.getElementById('phone').value || '+254 712 345 678';
            
            const planNames = {
                'daily': 'Daily Pass',
                'weekly': 'Weekly Plan',
                'monthly': 'Monthly Plan',
                'payperswap': 'Pay-Per-Swap'
            };
            
            const planPrices = {
                'daily': 'KES 150',
                'weekly': 'KES 800',
                'monthly': 'KES 2,500',
                'payperswap': 'KES 0'
            };
            
            document.getElementById('checkout-name').textContent = firstName + ' ' + lastName;
            document.getElementById('checkout-phone').textContent = phone;
            document.getElementById('checkout-plan').textContent = planNames[selectedPlan];
            document.getElementById('checkout-amount').textContent = planPrices[selectedPlan];
            document.getElementById('sales-reg-id').textContent = '#REG-' + Math.floor(100000 + Math.random() * 900000);
            document.getElementById('checkout-battery').textContent = 'BAT-2024-' + Math.floor(1000 + Math.random() * 9000);
        }

        function salesHandleMainAction() {
            switch(salesCurrentScreen) {
                case 1: salesGoToScreen(2); break;
                case 2: salesGoToScreen(3); break;
                case 3: salesSimulateBatteryScan(); break;
                case 4: 
                    // Reset form
                    document.getElementById('firstName').value = '';
                    document.getElementById('lastName').value = '';
                    document.getElementById('phone').value = '';
                    document.getElementById('nationalId').value = '';
                    document.getElementById('vehicleReg').value = '';
                    document.getElementById('vehicleType').value = '';
                    document.getElementById('vehicleModel').value = '';
                    salesGoToScreen(1);
                    break;
            }
        }

        function salesGoBack() {
            if (salesCurrentScreen > 1) salesGoToScreen(salesCurrentScreen - 1);
        }

        // =====================
        // Loading States
        // =====================
        function showLoading(text) {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        // =====================
        // Initialize & Events
        // =====================
        document.addEventListener('DOMContentLoaded', () => {
            // Check splash and onboarding state
            checkSplash();
            
            // Add swipe support for onboarding
            const slidesContainer = document.querySelector('.onboarding-slides');
            if (slidesContainer) {
                let touchStartX = 0;
                let touchEndX = 0;
                
                slidesContainer.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, { passive: true });
                
                slidesContainer.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    handleSwipe();
                }, { passive: true });
                
                function handleSwipe() {
                    const diff = touchStartX - touchEndX;
                    if (Math.abs(diff) > 50) {
                        if (diff > 0 && currentSlide < totalSlides - 1) {
                            // Swipe left - next
                            goToSlide(currentSlide + 1);
                        } else if (diff < 0 && currentSlide > 0) {
                            // Swipe right - previous
                            goToSlide(currentSlide - 1);
                        }
                    }
                }
            }
            
            // Handle window resize for timeline scroll indicator
            window.addEventListener('resize', () => {
                checkTimelineScroll();
                checkSalesTimelineScroll();
            });
        });

        // Touch feedback for interactive elements
        document.querySelectorAll('.btn, .toggle-btn, .scanner-area, .qr-scanner-area, .theme-toggle, .role-applet, .product-card').forEach(el => {
            el.addEventListener('touchstart', function() { 
                if (!this.classList.contains('disabled')) {
                    this.style.transform = 'scale(0.96)'; 
                }
            });
            el.addEventListener('touchend', function() { this.style.transform = ''; });
        });
        
        // Touch feedback for timeline steps
        document.querySelectorAll('.timeline-step').forEach(el => {
            el.addEventListener('touchstart', function() { 
                if (!this.classList.contains('disabled')) {
                    this.querySelector('.timeline-dot').style.transform = 'scale(0.9)';
                }
            });
            el.addEventListener('touchend', function() { 
                this.querySelector('.timeline-dot').style.transform = '';
            });
        });

        // System theme listener
        // System preference listener - only applies if user hasn't set a preference
        // App defaults to dark regardless of system preference
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Only respond to system changes if no saved preference
            // Since we default to dark, we don't auto-switch based on system
        });
    </script>
</body>
</html>
